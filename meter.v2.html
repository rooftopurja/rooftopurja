<!doctype html>
<html lang="en">
<head>
  

  <meta charset="utf-8" />
  <title>Meter - Solar Plant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    /* ========= simple knobs (change just these) ========= */
    :root{
      --h-kpi: 81px;     /* shorter KPI                          */
      --h-pie: 81px;     /* smaller pie                          */
      --h-bar: 315px;     /* big bar/line                         */
      --h-table: 315px;   /* big table                            */

      --bg:#fff; --fg:#0f172a; --muted:#64748b; --card:#f8fafc; --border:#e5e7eb;
      --accent:#2563eb; --chip:#eef2ff; --chip-fg:#1e3a8a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1400px;margin:10px auto 20px;padding:0 16px}
    header{font-size:20px;font-weight:800;letter-spacing:.2px;margin:2px 0 8px}

    /* filters */
    .filters{display:grid;grid-template-columns:1.2fr auto auto 1fr 1fr auto;gap:10px;align-items:center;
      background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
    .filters label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .filters input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:8px;font:inherit;width:100%}
    .preset{display:flex;gap:6px}
    .preset .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .preset .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}

    /* plant dropdown */
    .plant-select{position:relative}
    .plant-btn{width:100%;text-align:left;padding:10px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
    .dropdown{position:absolute;z-index:20;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:10px;margin-top:6px;max-height:320px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.08);display:none}
    .dropdown.open{display:block}
    .dd-row{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f1f5f9}
    .dd-row:last-child{border-bottom:none}
    .dd-row input{transform:scale(1.1)}
    .dd-h{font-weight:700}

    /* 2' '2 layout ''' no viewport clipping */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:auto auto;
      gap:12px;
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:hidden}
    .card-title{font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .badge{background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px;font-size:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:2px}

    /* KPI compact */
    .kpi-wrap{height:var(--h-kpi);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
    .kpi-label{color:var(--muted);letter-spacing:.04em}
    .kpi-value{font-size:42px;font-weight:800;line-height:1;margin-top:4px}
    .kpi-sub{color:var(--muted);margin-top:2px;font-size:13px}

    /* charts & table boxes */
    .pie-wrap{display:flex;align-items:center;justify-content:center;height:var(--h-pie)}
    .bar-wrap{height:var(--h-bar)}
    table{width:max(100%, 1200px);border-collapse:collapse;font-size:13px;table-layout:auto;white-space:nowrap}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:8px;text-align:left;font-weight:800}
    tbody td{border-bottom:1px solid var(--border);padding:8px}
    .muted{color:var(--muted)}
    .scroll{height:calc(var(--h-table) - 36px);overflow:auto;overflow-x:auto}
  </style>
<style>.wrap{margin-top:6px}</style>
  

  
<!-- ===== Small Footer ===== -->
<style>
  .sp-footer{margin-top:12px;border-top:1px solid #e5e7eb;background:#fff}
  .sp-footer .inner{max-width:1400px;margin:0 auto;padding:10px 16px;
    display:flex;gap:10px;justify-content:space-between;align-items:center;
    font:500 12px/1.4 Inter,system-ui,sans-serif;color:#64748b}
  .sp-footer a{color:#2563eb;text-decoration:none}
  .sp-footer a:hover{text-decoration:underline}
</style>
<footer class="sp-footer">
  <div class="inner">
    <div>''&copy; Solar Plant Dashboard</div>
  </div>
</footer>
<!-- ===== End Footer ===== -->

<!-- /site-nav-active -->

<!-- meter-align-script -->

<!-- /meter-align-script -->
<script src="nav.js" defer></script>


</body>
</html>















<!-- redeploy 2025-10-10T05:19:21 -->


















































<script>
  // ---- tiny helpers ----
  const $ = (sel, root=document) => root.querySelector(sel);

  async function jsonGET(url){
    const r = await fetch(url, { headers:{ "Accept":"application/json" }});
    if(!r.ok) throw new Error(String(r.status));
    return r.json();
  }

  // ---- PLANTS ----
  async function loadPlants(){
    // Call the working function name exactly (case-sensitive on SWA Linux)
    const data = await jsonGET("/api/PlantDirectory");
    const list = Array.isArray(data) ? data : (data?.plants || []);
    return list.map(p => ({
      id: String(p.id ?? p.Plant_ID ?? ""),
      name: String(p.name ?? p.DisplayPlant ?? p.Plant_Name ?? "Unknown")
    }));
  }

  async function fillPlants(){
    try{
      const dd = $("#plantSelect") || $("#plants") || $("#PlantSelect");
      if(!dd){ console.warn("plant dropdown not found"); return; }
      dd.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = ""; optAll.textContent = "All Plants";
      dd.appendChild(optAll);

      const items = await loadPlants();
      for(const p of items){
        const o = document.createElement("option");
        o.value = p.id; o.textContent = p.name;
        dd.appendChild(o);
      }
    }catch(e){
      console.error("plants fetch failed:", e?.message || e);
    }
  }

  // ---- METERS (uses your existing API) ----
  async function loadMeters(){
    const start = $("#start")?.value || "";
    const end   = $("#end")?.value   || "";
    const url = `/api/GetPremier300MeterAll?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&top=100000&${Date.now()}`;
    const data = await jsonGET(url);
    return Array.isArray(data) ? data : (data?.rows || []);
  }

  function filterByPlants(rows){
    const dd = $("#plantSelect") || $("#plants") || $("#PlantSelect");
    const sel = dd?.value ? String(dd.value).trim() : "";
    if(!sel) return rows;
    return rows.filter(r => String(r.Plant_ID ?? r.PlantId ?? r.Plant ?? "").trim() === sel);
  }

  async function run(){
    const btn = $("#applyBtn");
    try{
      if(btn) btn.disabled = true;
      const all = await loadMeters();
      const sel = filterByPlants(all);
      // Use your existing render functions if present; otherwise no-op
      try{ window.renderKPI    && window.renderKPI(sel);    }catch(_){}
      try{ window.renderPie    && window.renderPie(sel);    }catch(_){}
      try{ window.renderBarLine&& window.renderBarLine(sel);}catch(_){}
      try{ window.renderTable  && window.renderTable(sel);  }catch(_){}
    }catch(e){
      console.error(e); console.warn("UI notice:", "Failed to load data");
    }finally{
      if(btn) btn.disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      // If your code defines setDefaults, use it
      if(typeof window.setDefaults === "function"){ window.setDefaults(); }
      await fillPlants();
      const btn = $("#applyBtn");
      if(btn) btn.addEventListener("click", run);
      await run();
    }catch(e){ console.error(e); }
  });
</script>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);

  // Find a usable plant <select> even if it has no id (fallback: the first select on the page).
  function findPlantSelect(){
    return $('#plantSelect') || $('#plants') || $('#PlantSelect') || document.querySelector('select');
  }

  // Ensure date inputs have defaults (last 30 days) if blank.
  function setDateDefaults(){
    const allDates = Array.from(document.querySelectorAll('input[type="date"]'));
    const startEl = $('#start') || allDates[0] || null;
    const endEl   = $('#end')   || allDates[1] || allDates[0] || null;

    const pad = n => String(n).padStart(2,'0');
    const fmt = d => `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;

    const today = new Date();
    const thirtyAgo = new Date(); thirtyAgo.setDate(today.getDate()-30);

    if (startEl && !startEl.value) startEl.value = fmt(thirtyAgo);
    if (endEl   && !endEl.value)   endEl.value   = fmt(today);
  }

  // Patch fillPlants so it never fails if the select lacks an id.
  if (typeof window.fillPlants === 'function') {
    const _origFill = window.fillPlants;
    window.fillPlants = async function(){
      const dd = findPlantSelect();
      if (!dd) { console.warn('plant dropdown not found'); return; }
      if (!dd.id) dd.id = 'plantSelect';
      return _origFill.apply(this, arguments);
    };
  }

  // Patch loadMeters so it auto-sets dates before building the URL.
  if (typeof window.loadMeters === 'function') {
    const _origLoad = window.loadMeters;
    window.loadMeters = async function(){
      setDateDefaults();
      return _origLoad.apply(this, arguments);
    };
  }

  document.addEventListener('DOMContentLoaded', setDateDefaults);
})();
</script>
