<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Plant Dashboard - Meter</title>
  <link rel="stylesheet" href="common/style.css" />
</head>
<body>
  <!-- HEADER INCLUDE -->
  <div id="header"></div>
  <script>
    fetch("common/header.html")
      .then(r => r.text())
      .then(html => (document.getElementById("header").innerHTML = html))
      .catch(err => console.error("Header load failed:", err));
  </script>

  <div class="container">
    <h2 class="section-title">Meter Dashboard</h2>
    <p>Display meter readings, daily yield, and energy statistics here.</p>

    <div id="meter-cards" style="display:flex;gap:25px;margin-top:25px;flex-wrap:wrap;">
      <div class="meter-card">
        <h3>Total Yield (MWh)</h3>
        <p id="totalYield">--</p>
      </div>
      <div class="meter-card">
        <h3>Rows</h3>
        <p id="rowCount">--</p>
      </div>
      <div class="meter-card">
        <h3>Plants Selected</h3>
        <p id="plantCount">--</p>
      </div>
    </div>

    <div id="meter-chart" style="margin-top:40px;">
      <h3 style="color:#003366;">Last 30 Days Daily Total (kWh)</h3>
      <canvas id="dailyYieldChart" width="1200" height="350"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function loadMeterData() {
      try {
        const res = await fetch("/api/get-all-plant-data");
        const data = await res.json();

        if (!data || !data.meters) return;

        document.getElementById("totalYield").textContent =
          (data.meters.length * 100).toLocaleString() + " MWh";
        document.getElementById("rowCount").textContent = data.meters.length;
        document.getElementById("plantCount").textContent = data.plants?.length || "--";

        const ctx = document.getElementById("dailyYieldChart").getContext("2d");
        const labels = Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`);
        const values = labels.map(() => Math.floor(Math.random() * 2000 + 100));

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Daily Total (kWh)",
              data: values,
              backgroundColor: "rgba(0, 136, 255, 0.6)"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      } catch (err) {
        console.error("Error loading meter data:", err);
      }
    }
    loadMeterData();
  </script>
</body>
</html>
