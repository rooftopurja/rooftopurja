<!doctype html>
<html lang="en">
<head>
  

  <meta charset="utf-8" />
  <title>Meter - Solar Plant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  



<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);

  function ensurePlantSelect(){
    let sel = $('#plantSelect') || $('#plants') || $('#PlantSelect') || document.querySelector('select');
    // If page truly has no select, create one inside .filters (or at top)
    if(!sel){
      const host = $('.filters') || document.body;
      const wrap = document.createElement('div');
      wrap.innerHTML = '<label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px">Plant</label><select id="plantSelect" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></select>';
      host.insertBefore(wrap, host.firstChild || null);
      sel = wrap.querySelector('select');
    }
    if(!sel.id) sel.id = 'plantSelect';
    return sel;
  }

  function setDateDefaults(){
    const all = Array.from(document.querySelectorAll('input[type="date"]'));
    const startEl = $('#start') || all[0] || null;
    const endEl   = $('#end')   || all[1] || all[0] || null;
    const pad = n => String(n).padStart(2,'0');
    const fmt = d => `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
    const today = new Date();
    const ago   = new Date(); ago.setDate(today.getDate()-30);
    if (startEl && !startEl.value) startEl.value = fmt(ago);
    if (endEl   && !endEl.value)   endEl.value   = fmt(today);
  }

  // Replace any use of /api/PlantDirectory at runtime too (paranoia)
  async function fetchJSON(url){
    url = url.replace('/api/PlantDirectory','/api/PlantDirectory');
    const r = await fetch(url, {headers:{'Cache-Control':'no-cache'}});
    if(!r.ok) throw new Error(r.status);
    return r.json();
  }

  async function fillPlantsSafe(){
    const dd = ensurePlantSelect();
    dd.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = ''; optAll.textContent = 'All Plants';
    dd.appendChild(optAll);

    const items = await fetchJSON('/api/PlantDirectory');
    const list = Array.isArray(items?.plants) ? items.plants : items;
    for (const p of (list||[])) {
      const o = document.createElement('option');
      o.value = String(p.id ?? p.Plant_ID ?? p.PlantId ?? '').trim();
      o.textContent = String(p.name ?? p.DisplayPlant ?? p.Plant_Name ?? ('Plant ' + o.value)).trim();
      dd.appendChild(o);
    }
  }

  // If your page already defines loadMeters(), wrap it so dates exist
  if (typeof window.loadMeters === 'function') {
    const _orig = window.loadMeters;
    window.loadMeters = async function(){
      setDateDefaults();
      return _orig.apply(this, arguments);
    };
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      setDateDefaults();
      await fillPlantsSafe();
      // If your code has #applyBtn wire-up, keep it; otherwise call run() directly.
      if (typeof window.run === 'function') {
        const btn = document.getElementById('applyBtn');
        if (btn) btn.addEventListener('click', window.run);
        await window.run();
      }
    }catch(e){
      console.error('meter init failed:', e?.message||e);
    }
  });
})();
</script>
