<!doctype html>
<html lang="en">
<head>
  <script>
/* ---------- helpers ---------- */
const $ = sel => document.querySelector(sel);

async function fetchJSONSafe(url){
  const r = await fetch(url, { headers:{ "accept":"application/json" }});
  if(!r.ok){ const err = new Error(String(r.status)); err.status = r.status; throw err; }
  return r.json();
}

/* ---- Plants loader: tries both endpoints, both hosts ---- */
async function loadPlants(){
  const bases = ["", window.SWA_FALLBACK || "https://gray-desert-0663e5d00.2.azurestaticapps.net"];
  const paths = ["/api/PlantDirectory", "/api/plants"];
  for (const base of bases){
    for (const p of paths){
      try{
        const j = await fetchJSONSafe(base + p);
        const list = Array.isArray(j?.plants) ? j.plants : (Array.isArray(j) ? j : []);
        if (list && list.length){
          renderPlantDropdown(list);
          return list;
        }
      }catch(e){
        console.warn("plants fetch failed:", (e && e.status) || e, base + p);
      }
    }
  }
  console.warn("No plants found from any endpoint/host.");
  renderPlantDropdown([]);
  return [];
}

/* very simple dropdown renderer (keeps your existing ID #plantSelect) */
function renderPlantDropdown(list){
  const sel = document.querySelector('select[name="plantSelect"], #plantSelect') || document.querySelector('#Plants select') || $('#Plants');
  if (!sel) return;
  const current = sel.value || 'All';
  sel.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value='All'; optAll.textContent='All Plants'; sel.appendChild(optAll);
  for (const p of list){
    const o = document.createElement('option');
    o.value = String(p.id ?? p.Plant_ID ?? p.PlantId ?? p.plantId ?? p.name);
    o.textContent = String(p.name ?? p.DisplayPlant ?? p.Plant_Name ?? p.plantName ?? 'Plant');
    sel.appendChild(o);
  }
  sel.value = current;
}

/* ---------- main ---------- */
async function run(){
  try{
    const btn = $('#applyBtn'); if(btn) btn.disabled = true;
    const all = await loadMeters();   // your existing function in this file
    const sel = filterByPlants(all);  // your existing function in this file
    renderKPI(sel);                   // existing
    renderPie(sel);                   // existing
    renderBarLine(sel);               // existing
    renderTable(sel);                 // existing
  }catch(e){
    console.error(e); console.warn("UI notice:", "Failed to load data");
  }finally{
    const btn = $('#applyBtn'); if(btn) btn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  if (typeof setDefaults === 'function') setDefaults();
  await loadPlants();
  const btn = $('#applyBtn'); if(btn) btn.addEventListener('click', run);
  await run();
});
</script><script>
/* ---------- helpers ---------- */
const $ = sel => document.querySelector(sel);

async function fetchJSONSafe(url){
  const r = await fetch(url, { headers:{ "accept":"application/json" }});
  if(!r.ok){ const err = new Error(String(r.status)); err.status = r.status; throw err; }
  return r.json();
}

/* ---- Plants loader: tries both endpoints, both hosts ---- */
async function loadPlants(){
  const bases = ["", window.SWA_FALLBACK || "https://gray-desert-0663e5d00.2.azurestaticapps.net"];
  const paths = ["/api/PlantDirectory", "/api/plants"];
  for (const base of bases){
    for (const p of paths){
      try{
        const j = await fetchJSONSafe(base + p);
        const list = Array.isArray(j?.plants) ? j.plants : (Array.isArray(j) ? j : []);
        if (list && list.length){
          renderPlantDropdown(list);
          return list;
        }
      }catch(e){
        console.warn("plants fetch failed:", (e && e.status) || e, base + p);
      }
    }
  }
  console.warn("No plants found from any endpoint/host.");
  renderPlantDropdown([]);
  return [];
}

/* very simple dropdown renderer (keeps your existing ID #plantSelect) */
function renderPlantDropdown(list){
  const sel = document.querySelector('select[name="plantSelect"], #plantSelect') || document.querySelector('#Plants select') || $('#Plants');
  if (!sel) return;
  const current = sel.value || 'All';
  sel.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value='All'; optAll.textContent='All Plants'; sel.appendChild(optAll);
  for (const p of list){
    const o = document.createElement('option');
    o.value = String(p.id ?? p.Plant_ID ?? p.PlantId ?? p.plantId ?? p.name);
    o.textContent = String(p.name ?? p.DisplayPlant ?? p.Plant_Name ?? p.plantName ?? 'Plant');
    sel.appendChild(o);
  }
  sel.value = current;
}

/* ---------- main ---------- */
async function run(){
  try{
    const btn = $('#applyBtn'); if(btn) btn.disabled = true;
    const all = await loadMeters();   // your existing function in this file
    const sel = filterByPlants(all);  // your existing function in this file
    renderKPI(sel);                   // existing
    renderPie(sel);                   // existing
    renderBarLine(sel);               // existing
    renderTable(sel);                 // existing
  }catch(e){
    console.error(e); console.warn("UI notice:", "Failed to load data");
  }finally{
    const btn = $('#applyBtn'); if(btn) btn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  if (typeof setDefaults === 'function') setDefaults();
  await loadPlants();
  const btn = $('#applyBtn'); if(btn) btn.addEventListener('click', run);
  await run();
});
</script></body>
</html>















<!-- redeploy 2025-10-10T05:19:21 -->













































