<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Meter Analytics â€“ Rooftop Urja</title>

<!-- STYLES -->
<link rel="stylesheet" href="common/style.css" />
<link rel="stylesheet" href="common/header.css" />

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --maxw: 1180px;
  --pad: 14px;
  --blue: #0057d8;
  --orange: #f57c00;
  --text: #143559;
  --bg: #fafbfc;
  --panel: #fff;
  --shadow: 0 2px 8px rgba(0,0,0,.05);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
}

#header { position: sticky; top: 0; z-index: 100; }

/* FULL SCREEN CARD CONTAINER */
.stage {
  max-width: var(--maxw);
  margin: 16px auto 10px;
  background: var(--panel);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: var(--pad);
  display: flex;
  flex-direction: column;
  gap: 12px;

  /* Full-screen minus header */
 height: calc(100vh - 80px);   /* ðŸ”‘ lock dashboard to viewport */
}

/* FILTERS â€” SINGLE LINE, NO SCROLL */
.filters {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;        /* ðŸ”‘ never wrap */
  gap: 8px;                 /* ðŸ”‘ tighter spacing */
  border-bottom: 1px solid #e7ecf2;
  padding-bottom: 6px;      /* ðŸ”‘ slightly tighter */
}

/* Reduce button horizontal padding */
.filters button,
.filters select,
.filters input[type=date] {
  padding: 4px 10px;        /* ðŸ”‘ was wider earlier */
  height: 30px;             /* ðŸ”‘ slightly shorter */
  font-size: 0.9rem;
}

/* KEEP plant selector width AS-IS */
#plantBtn {
  min-width: 360px;
  max-width: 360px;
}


label { font-weight: 600; font-size: .92rem; }

select, button, input[type=date] {
  border: 1px solid var(--blue);
  border-radius: 18px;
  padding: 4px 12px;
  font-size: .92rem;
  background: #fff;
  color: var(--text);
  height: 32px;
}

.btn {
  background: #fff;
  color: var(--blue);
  border: 1px solid var(--blue);
  border-radius: 18px;
  padding: 4px 12px;
  font-weight: 600;
  height: 32px;
  cursor: pointer;
}

/* ðŸ”‘ BAR NAV ARROWS â€” COMPACT */
#barPrev, #barNext {
  width: 26px;
  height: 26px;
  padding: 0;
  border-radius: 50%;
  font-size: 0.75rem;
  line-height: 1;
}

#barPrev:disabled,
#barNext:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}


.btn.period.active {
  background: var(--blue);
  color: #fff;
}

/* ===== BAR NAVIGATION (LEAN ARROWS) ===== */
.bar-nav {
  border: 1px solid var(--blue);
  background: #fff;
  color: var(--blue);
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 10px;
  cursor: pointer;
  height: 22px;
  line-height: 1;
}

.bar-nav:hover {
  background: var(--blue);
  color: #fff;
}


/* MULTI-SELECT */
.multi { position: relative; display: inline-block; }
.multi-menu {
  display: none;
  position: absolute;
  top: 100%; left: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  max-height: 250px;
  overflow-y: auto;
  padding: 6px 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
  z-index: 999;
  width: 360px;
}

.multi-menu label {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;   /* ðŸ”‘ no wrapping */
  font-size: 0.85rem;
}

#plantBtn {
  min-width: 360px;      /* wider button */
  max-width: 360px;
  position: relative;
  padding-right: 22px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.hide { display: none !important; }

/* GRID LAYOUT (Option A â€” large charts) */
/* ===== GRID LAYOUT â€” RESTORE ORIGINAL WORKING STRUCTURE ===== */
.grid {
  display: grid;
  grid-template-columns: 72% 28%;
  grid-template-rows: 35% 65%;   /* ðŸ”‘ table+KPI top, charts bottom */
  gap: 12px;
  flex: 1;
  min-height: 0;
}

.card {
  background: var(--panel);
  border-radius: 10px;
  box-shadow: var(--shadow);
  padding: 10px;
  display: flex;
  flex-direction: column;
  min-height: 0;
  position: relative;
}

.card h2 {
  margin: 0 0 4px;
  font-size: .95rem;
  font-weight: 700;
  color: var(--text);
  border-left: 4px solid var(--blue);
  padding-left: 6px;
}

.scroll {
  overflow-y: auto;
  overflow-x: auto;
  max-height: 220px;   /* ðŸ”‘ caps table height */
}

table { width: 100%; border-collapse: collapse; font-size: .8rem; }
th, td {
  padding: 4px 4px;
  border-bottom: 1px solid #eef1f6;
  text-align: left;
  white-space: nowrap;
  font-size: 0.78rem;  /* ðŸ”‘ tighter rows */
}
th { background: #f1f6fd; }

/* ======================
   CHART CANVAS
====================== */
.chart {
  flex: 1;
  min-height: 0;   /* allow grid to control height */
}

.chart canvas {
  width: 100% !important;
  height: 100% !important;
}

/* ======================
   KPI CARD â€” CENTER CONTENT (NOT HEADING)
====================== */
.kpi {
  display: flex;
  flex-direction: column;
}

.kpi-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;   /* vertical center */
  align-items: center;       /* horizontal center */
}

.kpi .main {
  font-size: 2rem;
  color: var(--blue);
  font-weight: 800;
  text-align: center;
  width: 100%;
}

.kpi .delta {
  font-size: .9rem;
  color: var(--orange);
  margin-top: 6px;
  text-align: center;
  width: 100%;
}

.kpi .asof {
  font-size: .78rem;
  margin-top: 4px;
  text-align: center;
  width: 100%;
}

/* ======================
   PIE CHART â€” PERFECT CIRCLE
====================== */
.pie-card {
  display: flex;
  flex-direction: column;
}

.pie-card .chart {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pie-card canvas {
  aspect-ratio: 1 / 1;
  max-width: 100%;
  max-height: 100%;
}

/* ======================
   PLANT LABEL
====================== */
.plant-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
}

.plant-label .leaf {
  font-size: 1rem;
  line-height: 1;
}


</style>

</head>

<body>
<div id="header"></div>

<script>
fetch("common/header.v2.html")
  .then(r => r.text())
  .then(h => { document.getElementById("header").innerHTML = h; });
</script>

<div class="stage">

<!-- FILTER BAR -->
<div class="filters">
  <label class="plant-label">
  <span class="leaf">ðŸŒ¿</span> Select Plant(s):
</label>

  <div class="multi">
    <button id="plantBtn">All Plants</button>
    <div id="plantMenu" class="multi-menu"></div>
  </div>

  <label>Period:</label>

  <button class="btn period" data-p="date">Date</button>
  <input type="date" id="datePick" class="hide" />

  <button class="btn period" data-p="month">Month</button>
  <select id="monthPick" class="hide"></select>

  <button class="btn period" data-p="year">Year</button>
  <select id="yearPick" class="hide"></select>

  <button class="btn period active" data-p="lifetime">Lifetime</button>

  <div class="export">
    <select id="exportSel">
      <option>Export</option>
      <option value="csv">Export CSV</option>
      <option value="xlsx">Export Excel</option>
      <option value="pdf">Export PDF</option>
    </select>
  </div>
</div>

<!-- MAIN GRID -->
<div class="grid">

  <!-- TABLE -->
  <div class="card">
    <h2>Latest Meter Readings</h2>
    <div class="scroll">
      <table id="tbl">
<colgroup>
  <col style="width:26%">  <!-- Plant -->
  <col style="width:11%">  <!-- Serial -->
  <col style="width:9%">   <!-- Make -->
  <col style="width:11%">  <!-- Model -->
  <col style="width:6%">   <!-- Type -->
  <col style="width:9%">   <!-- Reading -->
  <col style="width:8%">   <!-- Yield -->
  <col style="width:20%">  <!-- Date -->
</colgroup>
        <thead>
          <tr>
            <th>Plant</th><th>Serial</th><th>Make</th><th>Model</th>
            <th>Type</th><th>Reading</th><th>Yield</th><th>Date_Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<!-- KPI CARD -->
<div class="card kpi">
  <h2>Total Yield (Selected Plants)</h2>

  <div class="kpi-body">
    <div id="kpi" class="main">--</div>
    <div id="delta" class="delta" style="display:none;"></div>
    <div id="asof" class="asof">As of --</div>
  </div>
</div>

  <!-- BAR + LINE CHART -->
 <div class="card">
  <h2>
    Energy (Last 9 Days)
    <span style="float:right; display:flex; gap:6px;">
      <button id="barPrev" class="bar-nav">â—€</button>
      <button id="barNext" class="bar-nav">â–¶</button>
    </span>
  </h2>
  <div class="chart">
    <canvas id="bar"></canvas>
  </div>
</div>

 <!-- PIE CHART -->
<div class="card pie-card">
  <h2>
    % Yield Contribution
    <div style="font-size:11px;color:#777;margin-top:2px;">
      Hover for details
    </div>
  </h2>
  <div class="chart">
    <canvas id="pie"></canvas>
  </div>
</div>


</div> <!-- END grid -->

</div> <!-- END stage -->

<script>
console.log("Meter page startingâ€¦");
Chart.register(ChartDataLabels);
/* ðŸ” AUTH FETCH WRAPPER â€” SINGLE SOURCE */
function authFetch(url, options = {}) {
  const token = localStorage.getItem("urja_token");

  if (!token) {
    window.location.replace("login.html");
    throw new Error("No auth token");
  }

  return fetch(url, {
  ...options,
  cache: "no-store",
  credentials: "include",   // ðŸ”‘ REQUIRED FOR req.user
  headers: {
    ...(options.headers || {}),
    "Authorization": `Bearer ${token}`,
    "Content-Type": "application/json"
  }
});
}


/* TOKEN-AWARE API CALLER */
const API_URL = "/api/GetMeterData";

/* FORMATTER: kWh â†’ MWh / GWh / TWh */
function fmtUnit(v) {
  let u = "kWh";
  if (v >= 1e12) { v /= 1e12; u = "TWh"; }
  else if (v >= 1e9) { v /= 1e9; u = "GWh"; }
  else if (v >= 1e6) { v /= 1e6; u = "MWh"; }
  return { v: Number(v.toFixed(3)), u };
}

/* AXIS UNIT SELECTION FOR TOTAL YIELD (kWh â†’ MWh / GWh / TWh) */
function axisUnitFromKWh(maxKWh) {
  if (maxKWh >= 1e9)  return { u: "TWh", scale: 1e9 };
  if (maxKWh >= 1e6)  return { u: "GWh", scale: 1e6 };
  if (maxKWh >= 1e3)  return { u: "MWh", scale: 1e3 };
  return { u: "kWh", scale: 1 };
}


// ðŸ”‘ KPI & DASHBOARD UNIT (FORCED READABILITY)
function dashboardUnit(totalKWh) {
  // â‰¥ 1 GWh â†’ show GWh
  if (totalKWh >= 1e6) {
    return { u: "GWh", scale: 1e6 };
  }

  // â‰¥ 1 MWh â†’ show MWh
  if (totalKWh >= 1e3) {
    return { u: "MWh", scale: 1e3 };
  }

  return { u: "kWh", scale: 1 };
}


// ðŸ”‘ UNIT NORMALISATION â€” ALWAYS RETURNS kWh
function toKwh(val, unit) {
  const v = Number(val) || 0;
  const u = String(unit || "kWh").toLowerCase();

  if (u === "twh") return v * 1e9;  // TWh â†’ kWh
  if (u === "gwh") return v * 1e6;  // GWh â†’ kWh
  if (u === "mwh") return v * 1e3;  // MWh â†’ kWh
  return v;                         // kWh
}

/* SELECTED PLANTS */
const selPlants = () => {
  const c = [...document.querySelectorAll('#plantMenu input[type=checkbox]')];
  if (!c.length || c[0].checked) return null; // ALL
  return c.filter(x => x.value !== 'all' && x.checked).map(x => x.value);
};

  // ðŸ”‘ Re-render on plant selection
document.getElementById("plantMenu").addEventListener("change", (e) => {
  const menu = document.getElementById("plantMenu");
  const allCb = menu.querySelector('input[value="all"]');
  const plantCbs = [...menu.querySelectorAll('input[type=checkbox]')].filter(x => x.value !== "all");

  // If ALL checked â†’ uncheck others
  if (e.target.value === "all" && e.target.checked) {
    plantCbs.forEach(cb => cb.checked = false);
    document.getElementById("plantBtn").textContent = "All Plants";
    fetchMeter();
    return;
  }

  // If any plant checked â†’ uncheck ALL
  if (e.target.value !== "all") {
    allCb.checked = false;
  }

  // If no plants checked â†’ fallback to ALL
  const picked = plantCbs.filter(x => x.checked);
  if (picked.length === 0) {
    allCb.checked = true;
    document.getElementById("plantBtn").textContent = "All Plants";
  } else {
    document.getElementById("plantBtn").textContent = `${picked.length} Plant(s)`;
  }

  fetchMeter();
});

// ðŸ”‘ TOGGLE PLANT DROPDOWN VISIBILITY  âœ… ADD HERE
document.getElementById("plantBtn").onclick = () => {
  const menu = document.getElementById("plantMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};

/* ======================================================
   GLOBALS
====================================================== */
let cache = null;
let period = "lifetime";
let barChart = null;
let pieChart = null;

// ðŸ”‘ BAR NAVIGATION STATE
let barOffset = 0;
const BAR_WINDOW = 9;


function buildPlantMenu() {
  const menu = document.getElementById("plantMenu");

  // âœ… remember current selections BEFORE rebuild
  const prevChecked = new Set(
    [...menu.querySelectorAll('input[type=checkbox]:checked')]
      .map(x => x.value)
  );

  menu.innerHTML = "";

  // ALL option
  const all = document.createElement("label");
  all.innerHTML = `<input type="checkbox" value="all" /> All Plants`;
  menu.appendChild(all);

  (cache.plants || []).forEach(p => {
    const lbl = document.createElement("label");
    lbl.innerHTML =
      `<input type="checkbox" value="${p.Plant_ID}" /> ${p.Plant_Name}`;
    menu.appendChild(lbl);
  });

  // âœ… restore checks
  const allCb = menu.querySelector('input[value="all"]');
  const plantCbs = [...menu.querySelectorAll('input[type=checkbox]')].filter(x => x.value !== "all");

  // if nothing was selected earlier OR "all" was selected â†’ keep ALL
  if (prevChecked.size === 0 || prevChecked.has("all")) {
    allCb.checked = true;
    plantCbs.forEach(cb => cb.checked = false);
    document.getElementById("plantBtn").textContent = "All Plants";
    return;
  }

  // otherwise restore individual selections
  allCb.checked = false;
  plantCbs.forEach(cb => cb.checked = prevChecked.has(cb.value));

  // update button label
  const picked = plantCbs.filter(x => x.checked);
  document.getElementById("plantBtn").textContent =
    picked.length ? `${picked.length} Plant(s)` : "All Plants";
}

/* ======================================================
   FETCH METER DATA (PERIOD-AWARE)
====================================================== */
async function fetchMeter() {
  
  const ids = selPlants();
  const plantsParam = ids ? ids.join(",") : "";

  const qs = new URLSearchParams();
qs.set("period", period);

  // âœ… Ensure period params are NEVER blank
if (period === "date") {
  const dp = document.getElementById("datePick");
  if (!dp.value) {
    // fallback to latest reading date OR last day from backend list
    const fallback =
      (cache?.latestReadings?.[0]?.Date_Time || "").slice(0, 10) ||
      (cache?.allDays?.at(-1)) ||
      (Object.keys(cache?.dailyData || {}).sort().at(-1)) ||
      "";
    if (fallback) dp.value = fallback;
  }
}

if (period === "month") {
  const ys = document.getElementById("yearPick");
  const ms = document.getElementById("monthPick");
  if (!ys.value && cache?.availableYears?.length) ys.value = cache.availableYears.at(-1);
  if (!ms.value && ys.value && cache?.availableMonthsByYear?.[ys.value]?.length) {
    ms.value = cache.availableMonthsByYear[ys.value].at(-1);
  }
}

if (period === "year") {
  const ys = document.getElementById("yearPick");
  if (!ys.value && cache?.availableYears?.length) ys.value = cache.availableYears.at(-1);
}


// âœ… Plant filter applies for KPI + PIE in ALL periods (and table in date)
if (plantsParam) qs.set("plants", plantsParam);


  if (period === "date") {
    const d = document.getElementById("datePick").value;
    if (d) qs.set("date", d);
  }

  if (period === "month") {
    qs.set("year", document.getElementById("yearPick").value);
    qs.set("month", document.getElementById("monthPick").value);
  }

  if (period === "year") {
    qs.set("year", document.getElementById("yearPick").value);
  }

  const url = `${API_URL}?${qs.toString()}`;
console.log("FETCH URL =>", url);

const r = await authFetch(url);

if (!r.ok) {
  console.error("Meter API failed", r.status);
  return;
}

const ct = r.headers.get("content-type") || "";
if (!ct.includes("application/json")) {
  const text = await r.text();
  console.error("âŒ GetMeterData returned non-JSON:", text.slice(0, 300));
  return;
}

cache = await r.json();
cache.period = period;

cache.pieData = cache.pie || [];

/* ===============================
   KPI â€” BACKEND AUTHORITATIVE
   Date does NOT affect KPI
=============================== */
cache.kpiTotalKWh =
  period === "month" ? cache.kpi?.month_kwh :
  period === "year"  ? cache.kpi?.year_kwh  :
                       cache.kpi?.lifetime_kwh;


/* ===============================
   TABLE â€” SIMPLE, STABLE
=============================== */
cache.latestReadings = cache.latest_rows || [];


// ðŸ” DERIVE AVAILABLE YEARS / MONTHS FROM chart[]
cache.availableYears = [];
cache.availableMonthsByYear = {};

if (Array.isArray(cache.chart)) {
  cache.chart.forEach(r => {
    const y = r.date.slice(0, 4);
    const m = r.date.slice(5, 7);

    if (!cache.availableYears.includes(y)) {
      cache.availableYears.push(y);
    }

    if (!cache.availableMonthsByYear[y]) {
      cache.availableMonthsByYear[y] = [];
    }

    if (!cache.availableMonthsByYear[y].includes(m)) {
      cache.availableMonthsByYear[y].push(m);
    }
  });

  cache.availableYears.sort();
  Object.values(cache.availableMonthsByYear).forEach(arr => arr.sort());
}


// ðŸ” ADAPT chart[] â†’ dailyData / allDays (FOR CHARTS)
cache.dailyData = {};
cache.allDays = [];

if (Array.isArray(cache.chart)) {
  cache.chart.forEach(r => {
    cache.dailyData[r.date] = r.kwh;
    cache.allDays.push(r.date);
  });
}

// ðŸ” DAILY SERIES (CORRECT: cumulative + incremental)
cache.dailyDataAll = {};
cache.dailyIncrementalAll = {};
cache.allDays = [];

if (Array.isArray(cache.chart)) {
  cache.chart.forEach(r => {
    cache.allDays.push(r.date);

    // ðŸ”‘ backend-truth
    cache.dailyIncrementalAll[r.date] = Number(r.daily_kwh || 0);
    cache.dailyDataAll[r.date]        = Number(r.total_kwh || 0);
  });
}


buildPlantMenu();              // âœ… ADD
buildPeriodUI_fromBackend();
render();
}

/* ======================================================
   PERIOD UI â€” DRIVEN BY BACKEND
====================================================== */
function buildPeriodUI_fromBackend() {
  const yearSel = document.getElementById("yearPick");
  const monthSel = document.getElementById("monthPick");
  const datePick = document.getElementById("datePick");

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  // ---- YEARS (ONLY AVAILABLE YEARS)
  yearSel.innerHTML = "";
  (cache.availableYears || []).forEach(y => {
    yearSel.innerHTML += `<option value="${y}">${y}</option>`;
  });

  if (cache.availableYears?.length && !yearSel.value) {
  yearSel.value = cache.availableYears.at(-1);
}

  // ---- MONTHS (ONLY AVAILABLE FOR SELECTED YEAR)
  function refreshMonths() {
  const y = yearSel.value;
  const prev = monthSel.value;   // ðŸ”‘ remember selection
  const months = cache.availableMonthsByYear?.[y] || [];

  monthSel.innerHTML = months.map(mm => {
    const idx = Number(mm) - 1;
    return `<option value="${mm}">${monthNames[idx] || mm}</option>`;
  }).join("");

  // ðŸ”‘ restore if still valid
  if (months.includes(prev)) {
    monthSel.value = prev;
  } else if (months.length) {
    monthSel.value = months.at(-1);
  }
}

  refreshMonths();

  yearSel.onchange = () => {
    refreshMonths();
    if (period === "month" || period === "year") fetchMeter();
  };

  monthSel.onchange = () => {
    if (period === "month") fetchMeter();
  };

  datePick.onchange = () => {
    if (period === "date") fetchMeter();
  };

  // ---- PERIOD BUTTONS
  document.querySelectorAll(".period").forEach(b => {
    b.onclick = () => {
      document.querySelectorAll(".period").forEach(x => x.classList.remove("active"));
      b.classList.add("active");

      period = b.dataset.p;

      datePick.classList.add("hide");
      monthSel.classList.add("hide");
      yearSel.classList.add("hide");

      if (period === "date") datePick.classList.remove("hide");
      if (period === "month") { monthSel.classList.remove("hide"); yearSel.classList.remove("hide"); }
      if (period === "year") yearSel.classList.remove("hide");

      fetchMeter();
    };
  });
}


function drawPie(items) {
  const ctx = document.getElementById("pie").getContext("2d");
  if (pieChart) pieChart.destroy();

// ðŸ”‘ always work in kWh internally
const valuesKWh = items.map(i => toKwh(i.val, i.unit));
const totalKWh = valuesKWh.reduce((a, b) => a + b, 0);

if (!totalKWh) return; // safety

// ðŸ”‘ PIE UNIT MUST BE BASED ON LARGEST SLICE (NOT TOTAL)
const maxSliceKWh = Math.max(...valuesKWh);

// âœ… Rooftop Urja unit thresholds:
// 1000 kWh -> MWh
// 1000 MWh -> GWh
// 1000 GWh -> TWh
let u = "kWh", scale = 1;
if (maxSliceKWh >= 1e9)      { u = "TWh"; scale = 1e9; }
else if (maxSliceKWh >= 1e6) { u = "GWh"; scale = 1e6; }
else if (maxSliceKWh >= 1e3) { u = "MWh"; scale = 1e3; }

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: items.map(i => i.name),
      datasets: [{
        data: valuesKWh.map(v => +(v / scale).toFixed(3)),
        backgroundColor: [
          "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
          "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        datalabels: { display: false },
        tooltip: {
          callbacks: {
            title: items => items[0]?.label || "",
            label: (ctx) => {
              const idx = ctx.dataIndex;
              const rawKWh = valuesKWh[idx] || 0;
              const pct = ((rawKWh / totalKWh) * 100).toFixed(2);
              return `${(rawKWh / scale).toFixed(3)} ${u} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function drawBar(labels, totKWh, incKWh) {
  const ctx = document.getElementById("bar").getContext("2d");
  if (barChart) barChart.destroy();

  const maxTotal = Math.max(...totKWh);
  const { u, scale } = axisUnitFromKWh(maxTotal);

  barChart = new Chart(ctx, {
    data: {
      labels,
datasets: [
  {
    type: "bar",
    label: "Cumulative Yield",
    data: totKWh.map(v => +(v / scale).toFixed(3)),

    backgroundColor: "#5FA8FF",
    borderRadius: 6,

    barPercentage: 0.7,        // â¬…ï¸ slightly wider
    categoryPercentage: 0.75,  // â¬…ï¸ slightly wider

    yAxisID: "y",
    order: 2,

    datalabels: {
      anchor: "end",
      align: "end",
      offset: 4,
      color: "#1F3A5F",
      font: { size: 11, weight: "600" },
      formatter: v => v
    }
  },
  {
    type: "line",
    label: "Daily Generation",
    data: incKWh.map(v => +v.toFixed(0)),

    borderColor: "#F57C00",
    backgroundColor: "transparent",
    tension: 0.35,
    borderWidth: 3,

    // ðŸ”‘ smaller, hollow points
    pointRadius: 4,
    pointHoverRadius: 5,
    pointBorderWidth: 2,
    pointBackgroundColor: "#FFFFFF",
    pointBorderColor: "#F57C00",

    yAxisID: "y1",
    order: 1,

    datalabels: {
      anchor: "end",
      align: "bottom",
      offset: 6,
      color: "#000000",   // âœ… BLACK, readable
      font: { size: 10, weight: "500" },
      formatter: v => v
    }
  }
]

   },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: `Total Yield (${u})` }
        },
        y1: {
          beginAtZero: true,
          position: "right",
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Daily Generation (kWh)" }
        }
      }
    }
  });
}


/* ======================================================
   RENDER PAGE â€” SINGLE SOURCE OF TRUTH
====================================================== */
function render() {
  try {
    if (!cache) return;


  /* ===============================
     TABLE
  =============================== */
  const rows = cache.latestReadings || [];
  document.querySelector("#tbl tbody").innerHTML =
    rows.map(r => `
      <tr>
        <td>${r.Plant_Name || "--"}</td>
        <td>${r.Meter_Serial_No || "--"}</td>
        <td>${r.Meter_Make || "--"}</td>
        <td>${r.Meter_Model || "--"}</td>
        <td>${r.Meter_Type || "--"}</td>
        <td>${r.Meter_Reading ?? "--"}</td>
        <td>${r.Total_Yield_Unit || "--"}</td>
        <td>${(r.Date_Time || "").replace("T", " ")}</td>
      </tr>
    `).join("");

  /* ===============================
     KPI â€” BACKEND AUTHORITATIVE
  =============================== */
  const totalKWh = Number(cache.kpiTotalKWh || 0);
  const { u, scale } = dashboardUnit(totalKWh);

  document.getElementById("kpi").textContent =
    `${(totalKWh / scale).toFixed(3)} ${u}`;


  /* ===============================
     AS OF â€” DATA DATE (NOT API TIME)
  =============================== */
  document.getElementById("asof").textContent =
    "As of " + (
      cache.requested?.date ||
      cache.allDays?.at(-1) ||
      "--"
    );

/* ===============================
   PIE â€” ONLY FOR MONTH / YEAR / LIFETIME
=============================== */

// âŒ Date period has NO pie (by design)
if (period !== "date") {
  const pieItems = (cache.pieData || []).map(p => ({
  name: p.Plant_Name,
  val: p.Value,
  unit: "kWh"
}));

 if (period !== "date" && pieItems.length) {
  drawPie(pieItems);
}

}

  /* ===============================
     BAR + LINE (LAST 9 DAYS â€” BACKEND)
  =============================== */
 if (barChart) {
  barChart.destroy();
  barChart = null;
}

  const allLabels = cache.allDays || [];
  const totalDays = allLabels.length;

  const maxOffset = Math.max(0, totalDays - BAR_WINDOW);
  barOffset = Math.max(0, Math.min(barOffset, maxOffset));

  const start = Math.max(0, totalDays - BAR_WINDOW - barOffset);
  const end   = totalDays - barOffset;

  const labels = allLabels.slice(start, end);
  const totals = labels.map(d => Number(cache.dailyDataAll?.[d] || 0));
  const inc    = labels.map(d => Number(cache.dailyIncrementalAll?.[d] || 0));

  document.getElementById("barPrev").disabled = barOffset >= maxOffset;
  document.getElementById("barNext").disabled = barOffset <= 0;

  if (labels.length) drawBar(labels, totals, inc);

  } catch (e) {
    console.error("RENDER FAILED:", e);
  }
}


/* ======================================================
   INIT
====================================================== */
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(fetchMeter, 200);

  document.getElementById("barPrev").onclick = () => {
    const totalDays = cache?.allDays?.length || 0;
    const maxOffset = Math.max(0, totalDays - BAR_WINDOW);
    barOffset = Math.min(barOffset + BAR_WINDOW, maxOffset);
    render();
  };

  document.getElementById("barNext").onclick = () => {
    barOffset = Math.max(0, barOffset - BAR_WINDOW);
    render();
  };

  // ðŸ”¹ EXPORT DROPDOWN HANDLER
  document.getElementById("exportSel").onchange = (e) => {
    const v = e.target.value;

    if (v === "csv" || v === "xlsx" || v === "pdf") {
      exportTable(v);
    }

    // reset dropdown back to "Export"
    e.target.selectedIndex = 0;
  };
});

function exportTable(format) {
  const rows = cache?.latestReadings || [];
  if (!rows.length) {
    alert("No data to export");
    return;
  }

  // Build flat table data
  const data = rows.map(r => ({
    Plant: r.Plant_Name,
    Serial: r.Meter_Serial_No,
    Make: r.Meter_Make,
    Model: r.Meter_Model,
    Type: r.Meter_Type,
    Reading: r.Meter_Reading,
    Yield: r.Total_Yield_Unit,
    Date_Time: r.Date_Time
  }));

  const filename = `MeterData_${period}_${new Date().toISOString().slice(0,10)}`;

  /* ---------- CSV / EXCEL ---------- */
  if (format === "csv" || format === "xlsx") {
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "MeterData");

    if (format === "csv") {
      XLSX.writeFile(wb, `${filename}.csv`);
    } else {
      XLSX.writeFile(wb, `${filename}.xlsx`);
    }
  }

  /* ---------- PDF ---------- */
  if (format === "pdf") {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l", "pt");

    doc.text("Meter Data Export", 40, 30);

    doc.autoTable({
      startY: 50,
      head: [Object.keys(data[0])],
      body: data.map(Object.values),
      styles: { fontSize: 8 }
    });

    doc.save(`${filename}.pdf`);
  }
}


</script>

<script src="common/loadUser.js"></script>

</body>
</html>