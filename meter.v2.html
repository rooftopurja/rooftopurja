<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Plant Dashboard - Meter</title>
  <link rel="stylesheet" href="common/style.css" />
</head>
<body>
  <!-- ===== Global Header Include ===== -->
  <div id="header"></div>
  <script>
    fetch("common/header.html")
      .then(r => r.text())
      .then(html => document.getElementById("header").innerHTML = html)
      .catch(err => console.error("Header load failed:", err));
  </script>

  <!-- ===== Main Page Content ===== -->
  <div class="container">
    <h2 class="section-title">Meter Dashboard</h2>
    <p>Display meter readings, daily yield, and energy statistics here.</p>

    <!-- Summary Cards -->
    <div id="meter-cards" style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
      <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 200px;">
        <h3>Total Yield</h3>
        <p id="totalYield">--</p>
      </div>
      <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 200px;">
        <h3>Rows</h3>
        <p id="rowCount">--</p>
      </div>
      <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 200px;">
        <h3>Plants Selected</h3>
        <p id="plantCount">--</p>
      </div>
    </div>

    <!-- Chart Placeholder -->
    <div id="meter-chart" style="margin-top: 40px;">
      <h3>Last 30 Days Daily Yield (kWh)</h3>
      <canvas id="dailyYieldChart" width="600" height="300"></canvas>
    </div>
  </div>

  <!-- ===== Chart.js (for visuals) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ===== Page Logic ===== -->
  <script>
    async function loadMeterData() {
      try {
        const res = await fetch("/api/get-all-plant-data");
        const data = await res.json();

        if (!data || !data.meters) {
          document.getElementById("totalYield").textContent = "No data";
          return;
        }

        // summary cards
        document.getElementById("totalYield").textContent = (data.meters.length * 100).toLocaleString() + " MWh";
        document.getElementById("rowCount").textContent = data.meters.length;
        document.getElementById("plantCount").textContent = data.plants ? data.plants.length : "--";

        // build chart (dummy demo data now)
        const ctx = document.getElementById("dailyYieldChart").getContext("2d");
        const labels = Array.from({length: 30}, (_, i) => `Day ${i+1}`);
        const values = labels.map(() => Math.floor(Math.random() * 2000 + 100));
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Daily Total (kWh)",
              data: values,
              backgroundColor: "rgba(0, 136, 255, 0.5)"
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      } catch (err) {
        console.error("Error loading meter data:", err);
      }
    }
    loadMeterData();
  </script>
</body>
</html>
