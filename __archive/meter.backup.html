<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8" />
  <title>Meter -Ã¢â€šÂ¬Ã¢â‚¬Â Solar Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js + datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg:#ffffff;
      --fg:#0f172a;
      --muted:#64748b;
      --card:#f8fafc;
      --chip:#e2e8f0;
      --chip-active:#2563eb;
      --chip-active-fg:#fff;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-2:#22c55e;
      --accent-3:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--fg);
      background:var(--bg);
    }
    .wrap{
      max-width: 1400px;   /* fits 1366/1920 without scroll */
      margin: 18px auto 28px;
      padding: 0 16px;
    }
    header{
      font-weight:700;
      font-size: 22px;
      margin-bottom: 14px;
    }

    /* FILTER BAR */
    .filters{
      display:grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap:12px;
      align-items:center;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:14px;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background:var(--chip-active);
      color:var(--chip-active-fg);
      border-color:transparent;
    }
    .preset{display:flex;gap:6px}
    .preset .chip{padding:6px 10px}
    .filters label{
      font-size:12px;color:var(--muted);display:block;margin-bottom:4px
    }
    .filters input[type="date"]{
      padding:8px 10px;border:1px solid var(--border);border-radius:8px;font:inherit
    }
    .btn{
      background:var(--accent);color:#fff;border:none;border-radius:10px;
      padding:10px 14px;font-weight:600;cursor:pointer;min-width:84px
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* GRID 2x2 (no page scroll) */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 320px 420px; /* keeps screen tight */
      gap:14px;
      height: calc(100vh - 160px); /* reserve for header+filters; keeps single screen */
      min-height:720px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px 16px 10px 16px;
      overflow:auto;
    }
    .kpi-wrap{
      height:100%;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      text-align:center
    }
    .kpi-label{color:var(--muted);letter-spacing:.04em}
    .kpi-value{font-size:54px;font-weight:800;line-height:1;margin-top:6px}
    .kpi-sub{color:var(--muted);margin-top:6px}

    /* TABLE */
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{
      text-align:left;font-weight:700;padding:10px;border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--card);
    }
    tbody td{padding:9px;border-bottom:1px solid var(--border)}
    .muted{color:var(--muted)}

    .card-title{font-weight:700;margin-bottom:10px}
    .badge{
      display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;
      padding:4px 10px;font-size:12px;margin-left:8px
    }

    /* Legend row under titles (small helper text) */
    .hint{font-size:12px;color:var(--muted);margin-bottom:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">Meter Overview</header>

    <!-- FILTERS -->
    <div class="filters">
      <div>
        <label>Plants</label>
        <div id="plantChips" class="chips">
          <div class="chip active" data-all="1" id="chip-all">All Plants</div>
          <!-- plant chips appended here -->
        </div>
      </div>

      <div>
        <label>Preset</label>
        <div class="preset">
          <div class="chip" data-preset="day">Day</div>
          <div class="chip" data-preset="month">Month</div>
          <div class="chip" data-preset="year">Year</div>
          <div class="chip active" data-preset="custom">Custom</div>
        </div>
      </div>

      <div>
        <label>Start</label>
        <input type="date" id="startDate">
      </div>
      <div>
        <label>End</label>
        <input type="date" id="endDate">
      </div>

      <div>
        <button class="btn" id="applyBtn">Apply</button>
      </div>
    </div>

    <!-- GRID 2x2 -->
    <div class="grid">
      <!-- KPI -->
      <div class="card" id="kpiCard">
        <div class="kpi-wrap">
          <div class="kpi-label">TOTAL YIELD</div>
          <div class="kpi-value" id="kpiTotal">0.000</div>
          <div class="kpi-sub" id="kpiUnit">(MWh)</div>
          <div class="hint" id="kpiContext"></div>
        </div>
      </div>

      <!-- Pie -->
      <div class="card">
        <div class="card-title">Yield Share by Plant <span class="badge" id="pieBadge">MWh</span></div>
        <div class="hint" id="pieHint">Hover to see values &amp; %.</div>
        <canvas id="pieChart" style="width:100%;height:calc(100% - 48px)"></canvas>
      </div>

      <!-- Table -->
      <div class="card">
        <div class="card-title">Latest Reading per Meter</div>
        <div class="hint" id="tableHint"></div>
        <div style="height: calc(100% - 60px); overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Plant</th>
                <th>Meter_ID</th>
                <th>Make</th>
                <th>Model</th>
                <th>Type</th>
                <th>Serial_No</th>
                <th>Reading</th>
                <th>Unit</th>
                <th class="muted">Time</th>
              </tr>
            </thead>
            <tbody id="latestBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Bar + Line -->
      <div class="card">
        <div class="card-title">Last 9 Days -Ã¢â€šÂ¬Ã¢â‚¬Â Total (bar) &amp; Daily (line) <span class="badge" id="barBadge">MWh</span></div>
        <div class="hint" id="barHint">Labels on bars/line show values; cumulative across selected plants.</div>
        <canvas id="barLine" style="width:100%;height:calc(100% - 48px)"></canvas>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const API_BASE = location.host.includes('localhost:4286') ? '' : ''; // SWA proxies /api in both cases
function fmtNum(x, digits=3){ return Number(x||0).toLocaleString(undefined,{maximumFractionDigits:digits}) }
function ymd(d){ return d.toISOString().slice(0,10) }
function parseDate(s){ return new Date(s) }
function sum(arr, sel= x=>x){ return arr.reduce((a,c)=>a+(+sel(c)||0),0) }
function groupBy(arr, keyFn){
  const m=new Map();
  for(const it of arr){
    const k=keyFn(it);
    if(!m.has(k)) m.set(k,[]);
    m.get(k).push(it);
  }
  return m;
}
function uniq(arr){return [...new Set(arr)]}

/* unit logic for MWh/GWh */
function toBestUnit(mwhValue){
  if(mwhValue>=1000) return { val: mwhValue/1000, unit:'GWh' };
  return { val: mwhValue, unit:'MWh' };
}

/* ---------- state ---------- */
let plants = [];         // {Plant_ID, Plant_Name}
let selectedPlantIds = new Set(); // empty = all
let start = new Date();  // will be set to this month
let end   = new Date();
let preset = 'custom';

const el = sel => document.querySelector(sel);

/* ---------- UI init ---------- */
function setDefaultDates(){
  const now=new Date();
  const s=new Date(now.getFullYear(), now.getMonth(), 1);
  const e=new Date(now.getFullYear(), now.getMonth()+1, 0);
  start=s; end=e;
  el('#startDate').value = ymd(s);
  el('#endDate').value   = ymd(e);
}
function attachPreset(){
  document.querySelectorAll('.preset .chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.preset .chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      preset = ch.dataset.preset;

      const now=new Date();
      if(preset==='day'){ start = end = now; }
      else if(preset==='month'){
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end   = new Date(now.getFullYear(), now.getMonth()+1, 0);
      } else if(preset==='year'){
        start = new Date(now.getFullYear(), 0, 1);
        end   = new Date(now.getFullYear(), 11, 31);
      }
      el('#startDate').value = ymd(start);
      el('#endDate').value   = ymd(end);
    });
  });
}
function attachDates(){
  el('#startDate').addEventListener('change', e=> start = new Date(e.target.value));
  el('#endDate').addEventListener('change',   e=> end   = new Date(e.target.value));
}

/* ---------- data fetchers ---------- */
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  // SWA emulator returns 204 for empty, guard it:
  const txt = await r.text();
  if(!txt) return null;
  return JSON.parse(txt);
}
async function loadPlants(){
  const js = await fetchJSON(`${API_BASE}/api/GetPlantMapping`);
  plants = (js?.data || js || []).map(p=>({
    Plant_ID: Number(p.Plant_ID),
    Plant_Name: String(p.Plant_Name)
  }));
  buildPlantChips();
}
function buildPlantChips(){
  const host = el('#plantChips');
  // clear non-all chips
  host.querySelectorAll('.chip[data-id]').forEach(n=>n.remove());
  for(const p of plants){
    const c = document.createElement('div');
    c.className='chip';
    c.dataset.id = String(p.Plant_ID);
    c.textContent = p.Plant_Name;
    c.addEventListener('click', ()=>{
      el('#chip-all').classList.remove('active');
      if(selectedPlantIds.has(p.Plant_ID)) selectedPlantIds.delete(p.Plant_ID);
      else selectedPlantIds.add(p.Plant_ID);
      c.classList.toggle('active');
    });
    host.appendChild(c);
  }
  // "All Plants" chip
  const all = el('#chip-all');
  all.onclick = ()=>{
    selectedPlantIds.clear();
    host.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    all.classList.add('active');
  };
}

async function loadMeterData(){
  const s = ymd(start), e = ymd(end);
  const js = await fetchJSON(`${API_BASE}/api/GetPremier300MeterAll?start=${s}&end=${e}&top=100000`);
  return js?.data || js || [];
}

/* ---------- rendering ---------- */
let pie, barline;

function plantNameById(id){
  const p = plants.find(x=>x.Plant_ID==id);
  return p ? p.Plant_Name : `Plant ${id}`;
}
function filterByPlants(rows){
  if(selectedPlantIds.size===0) return rows;
  return rows.filter(r=> selectedPlantIds.has(Number(r.Plant_ID)));
}
function onlyLast9Days(rows){
  const byDay = groupBy(rows, r => ymd(new Date(r.Date_Time)));
  const days = Array.from(byDay.keys()).sort().slice(-9);
  const set = new Set(days);
  return rows.filter(r => set.has(ymd(new Date(r.Date_Time))));
}

function renderKPI(rows){
  // total across rows (sum of Total_Yield in MWh; assume already MWh)
  const totalMWh = sum(rows, r=> Number(r.Total_Yield||0));
  const best = toBestUnit(totalMWh);
  el('#kpiTotal').textContent = fmtNum(best.val, 3);
  el('#kpiUnit').textContent  = `(${best.unit})`;
  el('#kpiContext').textContent = `Range: ${ymd(start)} -Ã¢â‚¬Â Ã¢â‚¬â„¢ ${ymd(end)} -Ã¢â€šÂ¬Ã‚Â¢ Plants: ${selectedPlantIds.size? `${selectedPlantIds.size} selected` : 'All'}`;
  el('#pieBadge').textContent = best.unit;
  el('#barBadge').textContent = best.unit;
}

function renderTable(rows){
  // latest per Meter_ID
  const byMeter = new Map();
  for(const r of rows){
    const k = r.Meter_ID;
    const dt = new Date(r.Date_Time);
    if(!byMeter.has(k) || dt > byMeter.get(k)._dt){
      const copy = {...r, _dt: dt};
      byMeter.set(k, copy);
    }
  }
  const latest = Array.from(byMeter.values())
    .sort((a,b)=>b._dt - a._dt);

  const tb = el('#latestBody');
  tb.innerHTML='';
  for(const r of latest){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${plantNameById(r.Plant_ID)}</td>
      <td>${r.Meter_ID}</td>
      <td>${r.Meter_Make||''}</td>
      <td>${r.Meter_Model||''}</td>
      <td>${r.Meter_Type||''}</td>
      <td class="muted">${r.Meter_Serial_No||''}</td>
      <td style="text-align:right">${fmtNum(r.Total_Yield,3)}</td>
      <td>${r.Yield_Unit||'MWh'}</td>
      <td class="muted">${String(r.Date_Time).replace('T',' ')}</td>
    `;
    tb.appendChild(tr);
  }
  el('#tableHint').textContent = `${latest.length} meters -Ã¢â€šÂ¬Ã‚Â¢ latest reading per meter`;
}

function renderPie(rows){
  // sum by plant (Total_Yield MWh)
  const byPlant = groupBy(rows, r=> Number(r.Plant_ID));
  const labels=[], values=[];
  for(const [pid, arr] of byPlant){
    labels.push(plantNameById(pid));
    values.push(sum(arr, r=> Number(r.Total_Yield||0)));
  }
  if(pie){ pie.destroy(); }
  pie = new Chart(document.getElementById('pieChart').getContext('2d'), {
    type:'pie',
    data:{ labels, datasets:[{ data:values }]},
    options:{
      plugins:{
        legend:{ position:'bottom' },
        tooltip:{ callbacks:{
          label: ctx=>{
            const v=ctx.parsed; const total=values.reduce((a,c)=>a+c,0)||1;
            const pct=(v/total*100).toFixed(1);
            return `${ctx.label}: ${fmtNum(v,2)} ${el('#pieBadge').textContent} (${pct}%)`;
          }
        }},
        datalabels:{ display:false }
      }
    }
  });
}

function renderBarLine(rows){
  // LAST 9 DAYS -Ã¢â€šÂ¬Ã¢â‚¬Â bars total yield (sum Total_Yield), line sum daily incremental (kWh)
  const byDay = groupBy(rows, r => ymd(new Date(r.Date_Time)));
  const days = Array.from(byDay.keys()).sort().slice(-9);

  const barVals = days.map(d=> sum(byDay.get(d), r=> Number(r.Total_Yield||0))); // MWh
  const lineVals= days.map(d=> sum(byDay.get(d), r=> Number(r.Incremental_Daily_Yield_KWH||0))); // kWh

  // scale bar to chosen unit
  const barTotal = sum(barVals);
  const best = toBestUnit(barTotal);
  const scaledBars = best.unit==='GWh' ? barVals.map(v=>v/1000) : barVals;

  if(barline){ barline.destroy(); }
  barline = new Chart(document.getElementById('barLine').getContext('2d'), {
    type:'bar',
    data:{
      labels: days.map(d=> new Date(d).toLocaleDateString()),
      datasets:[
        { type:'bar', label:`Total (${best.unit})`, data: scaledBars, order:2 },
        { type:'line', label:'Daily (kWh)', data: lineVals, yAxisID:'y2', tension:.25, order:1 }
      ]
    },
    options:{
      maintainAspectRatio:false,
      scales:{
        y:{ beginAtZero:true },
        y2:{ position:'right', beginAtZero:true, grid:{ drawOnChartArea:false } }
      },
      plugins:{
        legend:{ position:'bottom' },
        tooltip:{ enabled:true },
        datalabels:{
          color:'#111',
          anchor:'end', align:'end',
          formatter:(v,ctx)=>{
            return ctx.dataset.type==='bar' ? fmtNum(v,1) : fmtNum(v,0);
          }
        }
      }
    },
    plugins:[ChartDataLabels]
  });
  el('#barBadge').textContent = best.unit;
}

/* ---------- main ---------- */
async function run(){
  try{
    el('#applyBtn').disabled = true;

    const all = await loadMeterData();
    const sel = filterByPlants(all);
    const slice = onlyLast9Days(sel);

    renderKPI(sel);
    renderTable(sel);
    renderPie(sel);
    renderBarLine(slice);
  }catch(err){
    console.error(err);
    alert(`Failed to load meter data: ${err.message||err}`);
  }finally{
    el('#applyBtn').disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  setDefaultDates();
  attachPreset();
  attachDates();
  await loadPlants();
  // preselect: all
  await run();
  el('#applyBtn').addEventListener('click', run);
});
</script>
</body>
</html>






