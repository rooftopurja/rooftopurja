<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meter — Solar Monitoring</title>
<link rel="stylesheet" href="assets/style.css" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  body{background:#f6f7fb;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:16px}
  .row{display:grid;gap:16px}
  .row-2{grid-template-columns:1fr 1fr}
  .muted{color:#667085;font-size:12px}
  .kpi{font-size:40px;font-weight:800;letter-spacing:.3px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .chip.active{background:#1e40af;color:#fff;border-color:#1e40af}
  .toolbar{display:flex;gap:12px;align-items:center}
  .toolbar .right{margin-left:auto;display:flex;gap:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid #f0f2f5;font-size:13px;text-align:left}
  th{color:#475467;font-weight:600}
  .legend{display:flex;gap:16px;align-items:center;margin:8px 0 0 6px}
  .swatch{width:14px;height:6px;border-radius:4px;display:inline-block;vertical-align:middle}
  .swatch.blue{background:#93c5fd}
  .swatch.pink{background:#fda4af}
</style>
</head>
<body>
  <nav class="card" style="border-radius:0;">
    <div class="container" style="display:flex;gap:24px;align-items:center;">
      <strong>Solar Monitor</strong>
      <a href="index.html">Home</a>
      <a href="meter.html" style="font-weight:700;">Meter</a>
      <a href="inverter_analytics.html">Inverter Analytics</a>
      <a href="inverter_data_overview.html">Inverter Data Overview</a>
      <a href="inverter_faults.html">Inverter Faults</a>
      <a href="maintenance.html">Maintenance</a>
      <a href="about.html">About</a>
    </div>
  </nav>

  <div class="container">
    <h2>Meter Dashboard</h2>

    <div class="card">
      <div class="toolbar" style="flex-wrap:wrap;gap:16px;">
        <div style="min-width:260px;">
          <div class="muted">Plants (checkboxes)</div>
          <div id="plantChips" class="chips"></div>
        </div>

        <div class="right">
          <div>
            <div class="muted">Start</div>
            <input id="startDate" type="date" />
          </div>
          <div>
            <div class="muted">End</div>
            <input id="endDate" type="date" />
          </div>
          <button id="applyBtn" style="padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;">Apply</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">Tip: plant checkboxes control all visuals. Date range applies to KPI & Pie; table & bar/line show last 9 days.</div>
    </div>

    <div class="row row-2" style="margin-top:16px;">
      <div class="card">
        <div class="muted">KPI: Total Yield</div>
        <div id="kpiTotal" class="kpi">0.000 MWh</div>
        <div class="muted" id="kpiNote"></div>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <strong>Latest Readings</strong>
        </div>
        <div style="overflow:auto; max-height:360px; border-top:1px solid #f0f2f5; margin-top:8px;">
          <table id="tblLatest">
            <thead>
              <tr>
                <th>Meter_ID</th><th>Make</th><th>Type</th><th>Model</th>
                <th>Serial_No</th><th>Total_Yield</th><th>Unit</th><th>Date_Time</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="8" class="muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <strong>Total Yield (bar) & Daily Incremental (line)</strong>
      <div class="legend">
        <span class="swatch blue"></span><span class="muted">Total Yield (MWh)</span>
        <span class="swatch pink"></span><span class="muted">Incremental Daily (kWh)</span>
      </div>
      <canvas id="yieldChart" height="120" style="margin-top:8px;"></canvas>
    </div>
  </div>

<script>
const apiBase = location.hostname.includes("localhost")
  ? "http://localhost:4286"
  : "";

const $ = sel => document.querySelector(sel);
const plantChips = $("#plantChips");
const kpiTotal = $("#kpiTotal");
const kpiNote = $("#kpiNote");
const tblBody = $("#tblLatest tbody");
const startInput = $("#startDate");
const endInput = $("#endDate");
const applyBtn = $("#applyBtn");

let allPlants = [];       // [{Plant_ID, Plant_Name}]
let selectedPlants = new Set(); // numbers
let allRows = [];         // meter rows from API
let chart;

function fmtMWh(x){ return (Number(x)||0).toFixed(3) + " MWh"; }

function todayISO(d=0){
  const t = new Date(); t.setDate(t.getDate()+d);
  return t.toISOString().slice(0,10);
}

async function fetchJSON(url){
  const r = await fetch(url, { headers: { "Cache-Control":"no-cache" }});
  if(!r.ok){
    const t = await r.text();
    throw new Error(`HTTP ${r.status} - ${t}`);
  }
  return r.json();
}

function renderPlantChips(){
  plantChips.innerHTML = "";
  // "All Plants" chip
  const allChip = document.createElement("button");
  allChip.className = "chip active";
  allChip.textContent = "All Plants";
  allChip.onclick = () => {
    selectedPlants = new Set(allPlants.map(p=>p.Plant_ID));
    document.querySelectorAll(".chip").forEach(c=>c.classList.add("active"));
    refresh();
  };
  plantChips.appendChild(allChip);

  // individual plant chips
  for(const p of allPlants){
    const btn = document.createElement("button");
    btn.className = "chip active";
    btn.textContent = `${p.Plant_Name} (#${p.Plant_ID})`;
    btn.dataset.id = p.Plant_ID;
    btn.onclick = () => {
      const id = Number(btn.dataset.id);
      if(selectedPlants.has(id)){ selectedPlants.delete(id); btn.classList.remove("active"); }
      else { selectedPlants.add(id); btn.classList.add("active"); }
      refresh();
    };
    plantChips.appendChild(btn);
  }
  // default: all selected
  selectedPlants = new Set(allPlants.map(p=>p.Plant_ID));
}

function filterRows(){
  const s = new Date(startInput.value);
  const e = new Date(endInput.value);
  e.setHours(23,59,59,999);
  return allRows.filter(r=>{
    const pid = Number(r.Plant_ID ?? r.plant_id ?? 0);
    const dt  = new Date(r.Date_Time ?? r.date ?? r.timestamp ?? 0);
    return selectedPlants.has(pid) && dt>=s && dt<=e;
  });
}

function renderKPI(rows){
  const total = rows.reduce((sum,r)=> sum + Number(r.Total_Yield??r.total_mwh??0), 0);
  kpiTotal.textContent = fmtMWh(total);
  kpiNote.textContent = `Showing ${selectedPlants.size===allPlants.length?"All Plants":selectedPlants.size+" plant(s)"} | ${startInput.value} — ${endInput.value}`;
}

function renderTable(rows){
  if(rows.length===0){ tblBody.innerHTML = `<tr><td colspan="8" class="muted">No rows yet.</td></tr>`; return; }
  const latest = [...rows].sort((a,b)=> new Date(b.Date_Time)-new Date(a.Date_Time)).slice(0,50);
  tblBody.innerHTML = latest.map(r => `
    <tr>
      <td>${r.Meter_ID??""}</td>
      <td>${r.Meter_Make??""}</td>
      <td>${r.Meter_Type??""}</td>
      <td>${r.Meter_Model??""}</td>
      <td>${r.Meter_Serial_No??""}</td>
      <td>${(Number(r.Total_Yield)||0).toFixed(3)}</td>
      <td>${r.Yield_Unit??"MWh"}</td>
      <td>${r.Date_Time??""}</td>
    </tr>
  `).join("");
}

function renderChart(rows){
  // group by day
  const byDay = {};
  for(const r of rows){
    const d = (r.Date_Time??"").slice(0,10);
    if(!d) continue;
    if(!byDay[d]) byDay[d] = {mwh:0,kwh:0};
    byDay[d].mwh += Number(r.Total_Yield||0);
    byDay[d].kwh += Number(r.Incremental_Daily_Yield_KWH||0);
  }
  const days = Object.keys(byDay).sort();
  const mwh = days.map(d=> byDay[d].mwh);
  const kwh = days.map(d=> byDay[d].kwh);

  const ctx = document.getElementById("yieldChart");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"bar",
    data:{
      labels:days,
      datasets:[
        { type:"bar",  label:"Total Yield (MWh)", data:mwh, backgroundColor:"#93c5fd" },
        { type:"line", label:"Incremental Daily (kWh)", data:kwh, borderColor:"#fda4af", pointRadius:2, tension:.25, yAxisID:"y1" }
      ]
    },
    options:{
      responsive:true,
      scales:{
        y:{ beginAtZero:true, title:{display:true,text:"MWh"} },
        y1:{ beginAtZero:true, position:"right", grid:{drawOnChartArea:false}, title:{display:true,text:"kWh"} }
      },
      plugins:{ legend:{display:true, position:"bottom"} }
    }
  });
}

function refresh(){
  const rows = filterRows();
  renderKPI(rows);
  renderTable(rows);
  renderChart(rows);
}

async function init(){
  // dates: last 7 days
  endInput.value = todayISO(0);
  startInput.value = todayISO(-6);

  // plants
  const plantRes = await fetchJSON(`${apiBase}/api/GetPlantMapping`);
  allPlants = plantRes.data ?? [];
  renderPlantChips();

  // meter rows (max 100 for now)
  const url = `${apiBase}/api/GetPremier300MeterAll?start=${startInput.value}&end=${endInput.value}&top=100`;
  const meterRes = await fetchJSON(url);
  allRows = meterRes.data ?? [];

  refresh();
}

applyBtn.addEventListener("click", async ()=>{
  // re-query rows for the new range
  const url = `${apiBase}/api/GetPremier300MeterAll?start=${startInput.value}&end=${endInput.value}&top=100`;
  try{
    const meterRes = await fetchJSON(url);
    allRows = meterRes.data ?? [];
    refresh();
  }catch(e){ alert("Failed to load meter data:\n"+e.message); }
});

init().catch(err => {
  console.error(err);
  alert("Failed to initialize meter dashboard:\n" + err.message);
});
</script>
</body>
</html>
