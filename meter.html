<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meter — Solar Monitoring</title>

  <!-- Bootstrap (layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { background:#0b0c10; } /* dark navbar background contrast */
    .appbar { background:#0b5ed7; }
    .appbar a, .appbar .navbar-brand { color: #fff !important; }
    .page-wrap { background:#f6f7fb; min-height:100vh; }
    .section-title { font-weight:600; }
    .kpi-card { border: 1px solid #e6e6e6; }
    .kpi-value { font-weight: 800; font-size: 2.25rem; }
    .muted { color:#6c757d; font-size:.9rem; }
    .table thead th { font-weight:600; }
    .legend-swatch {
      display:inline-block;width:14px;height:10px;border-radius:3px;margin-right:.35rem;vertical-align:middle;
    }
    .legend-label { margin-right:1rem; font-size:.9rem; }
    .scroll-box { max-height:460px; overflow:auto; }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <nav class="navbar navbar-expand-lg appbar">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="index.html">Solar Monitor</a>
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="meter.html">Meter</a></li>
        <li class="nav-item"><a class="nav-link" href="inverter_analytics.html">Inverter Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="inverter_data_overview.html">Inverter Data Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="inverter_faults.html">Inverter Faults</a></li>
        <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
      </ul>
    </div>
  </nav>

  <div class="page-wrap pb-5">
    <div class="container-xxl py-4">
      <h5 class="section-title mb-3">Meter Dashboard</h5>

      <!-- Filters -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-4">
          <label class="form-label">Plants (checkboxes)</label>
          <div class="input-group">
            <select id="plantSelect" class="form-select">
              <option value="ALL" selected>All Plants</option>
            </select>
            <button id="btnReloadPlants" class="btn btn-outline-secondary" title="Reload plants">↻</button>
          </div>
          <div class="form-text">Tip: plant selection controls all visuals.</div>
        </div>

        <div class="col-6 col-lg-3">
          <label class="form-label">Quick Range (KPI & Pie)</label>
          <select id="quickRange" class="form-select">
            <option value="custom" selected>Custom</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7">Last 7 days</option>
            <option value="last30">Last 30 days</option>
            <option value="mtd">MTD</option>
            <option value="ytd">YTD</option>
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label class="form-label">Start</label>
          <input id="dtStart" type="date" class="form-control" />
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">End</label>
          <input id="dtEnd" type="date" class="form-control" />
        </div>
        <div class="col-6 col-lg-1 d-grid">
          <button id="btnApply" class="btn btn-primary">Apply</button>
        </div>
      </div>

      <!-- KPI -->
      <div class="row g-4 mt-3">
        <div class="col-12 col-lg-6">
          <div class="card kpi-card shadow-sm">
            <div class="card-body">
              <div class="muted mb-2">KPI: Total Yield</div>
              <div id="kpiTotalYield" class="kpi-value">0.000 MWh</div>
              <div id="kpiRangeLabel" class="muted mt-2">Showing All Plants | —</div>
            </div>
          </div>

          <div class="card mt-3 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">Total Yield (bar) & Daily Incremental (line)</div>
                <div>
                  <span class="legend-label"><span class="legend-swatch" style="background:#9ec5fe"></span>Total Yield (MWh)</span>
                  <span class="legend-label"><span class="legend-swatch" style="background:#f5a3b1"></span>Incremental Daily (kWh)</span>
                </div>
              </div>
              <canvas id="chartMain" height="150"></canvas>
              <div id="chartEmpty" class="text-muted small mt-2 d-none">No data for the selected period.</div>
            </div>
          </div>
        </div>

        <!-- Latest readings -->
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="fw-semibold mb-2">Latest Readings</div>
              <div class="table-responsive scroll-box">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Meter_ID</th>
                      <th>Make</th>
                      <th>Type</th>
                      <th>Model</th>
                      <th>Serial_No</th>
                      <th class="text-end">Total_Yield</th>
                      <th>Unit</th>
                      <th>Date_Time</th>
                    </tr>
                  </thead>
                  <tbody id="tblBody">
                    <tr><td colspan="8" class="text-muted">No rows yet.</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="text-end">
                <button id="btnTopMore" class="btn btn-sm btn-outline-secondary">Load more</button>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /row -->
    </div>
  </div>

  <script>
  // ---- Helpers --------------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const api = path => `/api/${path}`;

  function fmtMWh(v){ return (Number(v)||0).toLocaleString(undefined,{minimumFractionDigits:3, maximumFractionDigits:3}); }
  function fmtKWh(v){ return (Number(v)||0).toLocaleString(undefined,{maximumFractionDigits:0}); }
  function toISO(d){ return d.toISOString().split('T')[0]; }
  function parseDateInput(el){ return el.value ? new Date(el.value + 'T00:00:00') : null; }

  function rangeFromQuick(key){
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const end = new Date(today);
    let start = new Date(today);

    switch(key){
      case 'today': start = today; break;
      case 'yesterday': start = new Date(today); start.setDate(start.getDate()-1); end.setDate(end.getDate()-1); break;
      case 'last7': start.setDate(start.getDate()-6); break;
      case 'last30': start.setDate(start.getDate()-29); break;
      case 'mtd': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
      case 'ytd': start = new Date(today.getFullYear(), 0, 1); break;
      default: return null;
    }
    return {start, end};
  }

  // ---- State ---------------------------------------------------------------
  let chart;
  let topCount = 50;   // grows with "Load more"
  let plants = [];     // from GetPlantMapping

  // ---- UI wiring -----------------------------------------------------------
  window.addEventListener('DOMContentLoaded', async () => {
    // default dates: last 7 days
    const r = rangeFromQuick('last7');
    $('#dtStart').value = toISO(r.start);
    $('#dtEnd').value   = toISO(r.end);

    await loadPlants();
    await apply();

    $('#btnApply').addEventListener('click', () => { topCount = 50; apply(); });
    $('#btnReloadPlants').addEventListener('click', loadPlants);
    $('#quickRange').addEventListener('change', onQuickRange);
    $('#btnTopMore').addEventListener('click', () => { topCount += 100; apply(); });
  });

  async function onQuickRange(){
    const v = $('#quickRange').value;
    if (v === 'custom') return;
    const r = rangeFromQuick(v);
    $('#dtStart').value = toISO(r.start);
    $('#dtEnd').value   = toISO(r.end);
  }

  // ---- Data loading --------------------------------------------------------
  async function loadPlants(){
    try{
      const res = await fetch(api('GetPlantMapping'));
      if (!res.ok) throw new Error(await res.text());
      const rows = await res.json();

      plants = Array.isArray(rows) ? rows : [];
      const sel = $('#plantSelect');
      sel.innerHTML = `<option value="ALL" selected>All Plants</option>`;
      // Expecting rows like: { Plant_ID, Plant_Name } – fallback if fields differ
      plants.forEach(p => {
        const id = p.Plant_ID ?? p.PlantId ?? p.id ?? p.Name ?? 'P1';
        const name = p.Plant_Name ?? p.PlantName ?? p.name ?? `Plant ${id}`;
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = name;
        sel.appendChild(opt);
      });
    }catch(err){
      console.warn('Plant mapping failed:', err);
      // leave dropdown with "All Plants"
    }
  }

  async function apply(){
    const s = parseDateInput($('#dtStart'));
    const e = parseDateInput($('#dtEnd'));
    if (!s || !e || s>e){ alert('Please select a valid date range'); return; }

    const start = toISO(s); const end = toISO(e);
    const plant = $('#plantSelect').value; // reserved for future filter (if API supports)

    // Update KPI subtitle
    const plantName = plant==='ALL' ? 'All Plants' : ($('#plantSelect').selectedOptions[0]?.textContent ?? plant);
    $('#kpiRangeLabel').textContent = `Showing ${plantName} | ${start} — ${end}`;

    const url = api(`GetPremier300MeterAll?start=${start}&end=${end}&top=${topCount}`);
    let data = [];
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      data = await res.json();
      if (!Array.isArray(data)) data = [];
    }catch(err){
      console.error('Readings failed:', err);
      data = [];
    }

    // Optionally filter by plant if API doesn’t filter server-side
    if (plant !== 'ALL'){
      const pidKey = ['Plant_ID','PlantId','plant_id','plantId'].find(k => data.length && k in data[0]);
      if (pidKey) data = data.filter(r => String(r[pidKey]) === String(plant));
    }

    renderKPI(data);
    renderTable(data);
    renderChart(data, start, end);
  }

  // ---- Rendering -----------------------------------------------------------
  function renderKPI(rows){
    const totalMWh = rows.reduce((acc,r)=>{
      const v = Number(r.Total_Yield ?? r.TotalYield ?? r.total_yield ?? 0);
      const unit = (r.Unit ?? r.unit ?? 'MWh').toUpperCase();
      // Assume MWh; if kWh convert to MWh
      return acc + (unit === 'KWH' ? v/1000 : v);
    },0);
    $('#kpiTotalYield').textContent = `${fmtMWh(totalMWh)} MWh`;
  }

  function renderTable(rows){
    const body = $('#tblBody');
    body.innerHTML = '';
    if (!rows.length){
      body.innerHTML = `<tr><td colspan="8" class="text-muted">No rows yet.</td></tr>`;
      return;
    }
    // Sort latest first by Date_Time
    rows.sort((a,b)=> new Date(b.Date_Time ?? b.DateTime ?? b.date ?? 0) - new Date(a.Date_Time ?? a.DateTime ?? a.date ?? 0));
    for (const r of rows){
      const tr = document.createElement('tr');
      const val = (n)=> r[n] ?? r[n.toLowerCase()] ?? '';
      const total = Number(r.Total_Yield ?? r.TotalYield ?? r.total_yield ?? 0);
      const unit  = (r.Unit ?? r.unit ?? '').toUpperCase();
      const shown = unit==='KWH' ? `${fmtKWh(total)} kWh` : `${fmtMWh(total)} MWh`;
      tr.innerHTML = `
        <td>${val('Meter_ID')}</td>
        <td>${val('Make')}</td>
        <td>${val('Type')}</td>
        <td>${val('Model')}</td>
        <td>${val('Serial_No')}</td>
        <td class="text-end">${shown}</td>
        <td>${unit || 'MWh'}</td>
        <td>${val('Date_Time') || val('DateTime')}</td>
      `;
      body.appendChild(tr);
    }
  }

  function renderChart(rows, startISO, endISO){
    // Bar: total per meter (MWh)
    const perMeter = {};
    rows.forEach(r=>{
      const id = String(r.Meter_ID ?? r.MeterId ?? r.meter_id ?? r.Serial_No ?? 'Meter');
      const unit = (r.Unit ?? r.unit ?? 'MWh').toUpperCase();
      const v = Number(r.Total_Yield ?? r.TotalYield ?? r.total_yield ?? 0);
      const mwh = unit==='KWH' ? v/1000 : v;
      perMeter[id] = (perMeter[id] ?? 0) + mwh;
    });

    const barLabels = Object.keys(perMeter);
    const barData   = barLabels.map(k=> perMeter[k]);

    // Line: daily incremental (kWh) summed across meters
    const perDayKWh = {};
    const s = new Date(startISO); const e = new Date(endISO);
    // initialize all days to 0 (for a continuous x-axis)
    for (let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      perDayKWh[toISO(d)] = 0;
    }
    rows.forEach(r=>{
      const unit = (r.Unit ?? r.unit ?? 'MWh').toUpperCase();
      const v = Number(r.Total_Yield ?? r.TotalYield ?? r.total_yield ?? 0);
      // If API already returns daily “incremental”, great; otherwise treat Total_Yield as daily total.
      // To keep it generic, we assume values are per reading at given Date_Time; sum as kWh.
      const asKWh = unit==='MWH' ? v*1000 : v;
      const day = (r.Date_Time ?? r.DateTime ?? '').slice(0,10);
      if (day && perDayKWh.hasOwnProperty(day)) perDayKWh[day] += asKWh;
    });

    const lineLabels = Object.keys(perDayKWh).sort();
    const lineData   = lineLabels.map(k=> perDayKWh[k]);

    const ctx = document.getElementById('chartMain').getContext('2d');
    if (chart) chart.destroy();

    const hasBars = barLabels.length>0 && barData.some(x=>x>0);
    const hasLine = lineLabels.length>0 && lineData.some(x=>x>0);
    document.getElementById('chartEmpty').classList.toggle('d-none', hasBars||hasLine);

    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: hasBars ? barLabels : lineLabels,
        datasets: [
          {
            type:'bar',
            label:'Total Yield (MWh)',
            data: hasBars ? barData : lineLabels.map(_=>0),
            backgroundColor:'#9ec5fe',
            borderColor:'#9ec5fe',
            borderWidth:1,
            yAxisID:'y1',
          },
          {
            type:'line',
            label:'Incremental Daily (kWh)',
            data: hasLine ? lineData : [],
            borderColor:'#f5a3b1',
            backgroundColor:'#f5a3b1',
            borderWidth:2,
            tension:.25,
            yAxisID:'y2',
          }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x: { ticks:{ maxRotation:0, autoSkip:true } },
          y1:{ type:'linear', position:'left', title:{display:true, text:'MWh'} },
          y2:{ type:'linear', position:'right', grid:{ drawOnChartArea:false }, title:{display:true, text:'kWh'} }
        },
        plugins:{
          legend:{ display:true },
          tooltip:{ mode:'index', intersect:false }
        }
      }
    });
  }
  </script>
</body>
</html>
