<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Inverter Analytics — Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>if (window.Chart && window.ChartDataLabels){ Chart.register(ChartDataLabels); }</script>
<style>
  :root{--b:#e6e6e6;--bg:#fafafa;--fg:#111}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  .container{max-width:1200px;margin:0 auto}
  .topnav{display:flex;gap:16px;align-items:center;padding:10px 16px;border-bottom:1px solid var(--b);background:#fff;position:sticky;top:0;z-index:10}
  .topnav a{color:#333;text-decoration:none;padding:6px 10px;border-radius:8px}
  .topnav a.active{background:#efefef;font-weight:600}
  .wrap{padding:12px 16px}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 10px}
  select,input[type=date],button{height:34px;border-radius:8px;border:1px solid #ddd;padding:0 10px;background:#fff}
  button{cursor:pointer}
  .btn{padding:0 10px}
  .seg{display:flex;border:1px solid #ddd;border-radius:8px;overflow:hidden}
  .seg button{border:0;border-right:1px solid #ddd;background:#fff}
  .seg button.active{background:#efefef;font-weight:600}
  .ms{position:relative}
  .ms>.face{min-width:220px;display:flex;align-items:center;justify-content:space-between}
  .ms .panel{position:absolute;top:38px;left:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.08);min-width:240px;max-height:260px;overflow:auto;display:none;padding:8px;z-index:9}
  .ms.open .panel{display:block}
  .ms .row{display:flex;gap:8px;align-items:center;padding:6px 4px}
  .muted{color:#777;font-size:12px}
  .kpis{display:grid;grid-template-columns:repeat(3, minmax(220px, 1fr));gap:10px;margin-bottom:10px}
  .card{background:#fff;border:1px solid var(--b);border-radius:10px;padding:10px}
  .kpi-label{font-size:11px;letter-spacing:.08em;color:#555}
  .kpi-value{font-size:26px;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  canvas{background:#fff;border:1px solid var(--b);border-radius:10px;padding:6px}
  .chart-wrap{height:320px}
</style>
</head>
<body>
<nav class="topnav container">
  <strong>Solar Plant Dashboard</strong>
  <a href="meter.v2.html">Meter</a>
  <a class="active" href="inverter_analytics.html">Inverter_Analytics</a>
  <a href="inverter_data_overview.html">Inverter_Data_Overview</a>
  <a href="inverter_faults.html">Inverter_Faults</a>
  <a href="maintenance.html">Maintenance</a>
  <span style="flex:1"></span>
  <span class="muted">fast day + range view</span>
</nav>

<div class="wrap container">
  <div class="bar">
    <!-- Plant multiselect -->
    <div class="ms" id="plantMS">
      <button class="face btn" type="button">Plant: <span id="plantFace">All</span> ▾</button>
      <div class="panel" id="plantPanel">
        <div class="row"><input type="checkbox" id="p_all" checked> <label for="p_all"><b>All plants</b></label></div>
        <hr/><div id="plantList"></div><hr/>
        <div class="row"><button class="btn" id="plantApply">Apply</button><span class="muted">Esc or click outside to close</span></div>
      </div>
    </div>

    <!-- View selector -->
    <div class="seg">
      <button class="btn active" id="v_day"      data-view="day">Day</button>
      <button class="btn"          id="v_week"     data-view="week">Week</button>
      <button class="btn"          id="v_month"    data-view="month">Month</button>
      <button class="btn"          id="v_year"     data-view="year">Year</button>
      <button class="btn"          id="v_lifetime" data-view="lifetime">Lifetime</button>
      <button class="btn"          id="v_custom"   data-view="custom">Custom</button>
    </div>

    <input id="dateOne" type="date">
    <input id="dateFrom" type="date" style="display:none">
    <span id="dash" style="display:none">—</span>
    <input id="dateTo" type="date" style="display:none">
    <button class="btn" id="btnToday">Today</button>
    <button class="btn" id="btnPrev">◀</button>
    <button class="btn" id="btnNext">▶</button>
  </div>

  <div class="kpis">
    <div class="card">
      <div class="kpi-label">TOTAL YIELD</div>
      <div class="kpi-value"><span id="kpiTotalYield">0.00</span> <span id="kpiUnit" class="muted">MWh</span></div>
    </div>
    <div class="card"><div class="kpi-label">CUF</div><div class="kpi-value">— <span class="muted">coming soon</span></div></div>
    <div class="card"><div class="kpi-label">PR</div><div class="kpi-value">— <span class="muted">coming soon</span></div></div>
  </div>

  <div class="grid">
    <div>
      <div style="margin:4px 0 6px 2px;"><b>Daily Power Curve</b></div>
      <div class="chart-wrap"><canvas id="powerChart"></canvas></div>
    </div>
    <div>
      <div style="margin:4px 0 6px 2px;"><b id="yieldTitle">Yield (daily total)</b> <span class="muted" id="yieldNote"></span></div>
      <div class="chart-wrap"><canvas id="yieldChart"></canvas></div>
    </div>
  </div>
</div>

<script>
(function(){
  // --------- small helpers ----------
  const $  = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const pad=n=>String(n).padStart(2,'0');
  const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  // --------- charts ----------
  const powerChart = new Chart($('#powerChart'), {
    type:'line',
    data:{labels:[],datasets:[
      {label:'AC kW',data:[],borderWidth:2,tension:.25,fill:true,pointRadius:2,backgroundColor:'rgba(54,162,235,.12)',
       datalabels:{anchor:'end',align:'bottom',offset:2,formatter:v=>v?Math.round(v):''}},
      {label:'DC kW',data:[],borderWidth:2,tension:.25,fill:true,pointRadius:2,backgroundColor:'rgba(255,99,132,.10)',
       datalabels:{anchor:'end',align:'top',offset:2,formatter:v=>v?Math.round(v):''}}
    ]},
    options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>Math.round(v)},title:{display:true,text:'kW'}}},
             plugins:{legend:{position:'top',labels:{padding:22}}}},
    plugins:(window.ChartDataLabels?[ChartDataLabels]:[])
  });

  const yieldChart = new Chart($('#yieldChart'), {
    type:'bar',
    data:{labels:[],datasets:[{label:'Yield',data:[]}]},
    options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>Math.round(v)},title:{display:true,text:'kWh'}}},
             plugins:{legend:{position:'top',labels:{padding:12}},
                      datalabels:{anchor:'end',align:'top',offset:2,formatter:v=>v?Math.round(v):''}}},
    plugins:(window.ChartDataLabels?[ChartDataLabels]:[])
  });

  // --------- UI refs ----------
  const plantMS=$('#plantMS'), plantList=$('#plantList'), plantFace=$('#plantFace'),
        pAll=$('#p_all'), plantApply=$('#plantApply');
  const dateOne=$('#dateOne'), dateFrom=$('#dateFrom'), dateTo=$('#dateTo'), dash=$('#dash'),
        btnToday=$('#btnToday'), btnPrev=$('#btnPrev'), btnNext=$('#btnNext');
  const kpiVal=$('#kpiTotalYield'), kpiUnit=$('#kpiUnit'), yieldNote=$('#yieldNote'), yieldTitle=$('#yieldTitle');
  const viewBtns=[$('#v_day'),$('#v_week'),$('#v_month'),$('#v_year'),$('#v_lifetime'),$('#v_custom')];

  // --------- state ----------
  let view='day';
  let selectedPlantIds=['all'];
  const plantToInv = new Map(); // Plant_ID -> Set(Inverter_*)

  // --------- fetch: abort old + debounce ----------
  let currentController=null;
  function fetchAbortable(url, ms=15000){
    if(currentController) currentController.abort();
    currentController=new AbortController();
    const t=setTimeout(()=>currentController.abort(), ms);
    return fetch(url,{signal:currentController.signal,cache:'no-store'})
      .finally(()=>clearTimeout(t));
  }
  let debounceTimer=null;
  const debounced = (fn,wait=180)=>((...a)=>{clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>fn(...a),wait);});

  // --------- plant UI ----------
  plantMS.querySelector('.face').onclick=()=>plantMS.classList.toggle('open');
  document.addEventListener('click',e=>{ if(!plantMS.contains(e.target)) plantMS.classList.remove('open'); });
  pAll.onchange=()=>{ if(pAll.checked){ $$('#plantList input[type=checkbox]').forEach(c=>c.checked=false); plantFace.textContent='All'; } };
  plantApply.onclick=()=>{ const ids=$$('#plantList input[type=checkbox]:checked').map(c=>c.value);
    if(ids.length===0){ selectedPlantIds=['all']; plantFace.textContent='All'; pAll.checked=true; }
    else { selectedPlantIds=ids; plantFace.textContent=ids.length===1?`Plant ${ids[0]}`:`${ids.length} plants`; pAll.checked=false; }
    plantMS.classList.remove('open'); refresh();
  };

  function parseInverters(val){
    const out=new Set();
    const feed=(x)=>{ if(!x) return;
      if(Array.isArray(x)) return x.forEach(feed);
      if(typeof x==='object') return Object.values(x).forEach(feed);
      if(typeof x!=='string') return;
      try{feed(JSON.parse(x));return;}catch{}
      x.split(/[,;|\s]+/g).map(t=>t.trim()).filter(t=>/^Inverter_/i.test(t)).forEach(t=>out.add(t));
    }; feed(val); return out;
  }

  async function loadPlants(){
    plantList.innerHTML="";
    const seen=new Map();
    const add=(id,name)=>{const s=String(id||"").trim();if(!s)return;if(!seen.has(s))seen.set(s,name||`Plant ${s}`);};
    try{
      const r=await fetchAbortable('/api/GetPlantDirectory', 8000);
      if(r.ok){
        const rows=await r.json();
        rows.forEach(e=>{
          const pid=e.Plant_ID ?? e.plant_id ?? e.PartitionKey ?? e.RowKey;
          const pname=e.Plant_Name ?? e.plant_name ?? e.name ?? `Plant ${pid}`;
          add(pid,pname);
          const invs=parseInverters(e.Inverters ?? e.inverters ?? e.Devices ?? e.devices ?? e.Inverter_ID);
          if(!plantToInv.has(String(pid))) plantToInv.set(String(pid), new Set());
          invs.forEach(x=>plantToInv.get(String(pid)).add(x));
        });
      }
    }catch{}
    [...seen.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([pid,pname])=>{
      const div=document.createElement('div'); div.className='row';
      div.innerHTML=`<input type="checkbox" id="p_${pid}" value="${pid}"> <label for="p_${pid}">${pname}</label>`;
      plantList.appendChild(div);
    });
  }

  function invCsvForSelection(){
    const set=new Set();
    if(selectedPlantIds[0]==='all'){ plantToInv.forEach(s=>s.forEach(x=>set.add(x))); }
    else { selectedPlantIds.forEach(pid=>{ const s=plantToInv.get(pid); if(s) s.forEach(x=>set.add(x)); }); }
    return [...set].sort().join(',');
  }

  // --------- view/date navigation ----------
  function setView(v){
    view=v; viewBtns.forEach(b=>b.classList.toggle('active', b.dataset.view===v));
    const show=(v==='custom'); dateFrom.style.display=show?'':'none'; dateTo.style.display=show?'':'none'; dash.style.display=show?'':'none';
    refresh();
  }
  $('#v_day').onclick=()=>setView('day');
  $('#v_week').onclick=()=>setView('week');
  $('#v_month').onclick=()=>setView('month');
  $('#v_year').onclick=()=>setView('year');
  $('#v_lifetime').onclick=()=>setView('lifetime');
  $('#v_custom').onclick=()=>setView('custom');

  btnToday.onclick=()=>{ dateOne.value=ymd(new Date()); refresh(); };
  function shiftAnchor(dir){
    const d=new Date(dateOne.value);
    if(view==='day'||view==='custom') d.setDate(d.getDate()+dir);
    else if(view==='week') d.setDate(d.getDate()+7*dir);
    else if(view==='month') d.setMonth(d.getMonth()+dir);
    else if(view==='year') d.setFullYear(d.getFullYear()+dir);
    const today=ymd(new Date()); if(dir>0 && ymd(d)>today) return;
    dateOne.value=ymd(d); refresh();
  }
  btnPrev.onclick=()=>shiftAnchor(-1);
  btnNext.onclick=()=>shiftAnchor(+1);
  dateOne.onchange=()=>refresh();
  dateFrom.onchange=()=>refresh();
  dateTo.onchange=()=>refresh();

  // --------- refresh (debounced) ----------
  async function _refresh(){
    yieldTitle.textContent =
      view==='day'      ? 'Yield (daily total)' :
      view==='week'     ? 'Yield (daily)' :
      view==='month'    ? 'Yield (monthly)' :
      view==='year'     ? 'Yield (yearly)' :
      view==='lifetime' ? 'Yield (lifetime)' : 'Yield (range)';
    yieldNote.textContent='(loading…)';

    const params={ view, date:dateOne.value };
    const invCsv = invCsvForSelection();
    if(invCsv) params.invIds = invCsv;
    if(view==='custom' && dateFrom.value && dateTo.value){ params.dateFrom=dateFrom.value; params.dateTo=dateTo.value; }

    const url='/api/inverter-analytics?'+new URLSearchParams(params);
    console.log('API:', url);

    let json=null;
    try{ const r=await fetchAbortable(url, 15000); if(r.ok) json=await r.json(); }catch(e){}

    if(!json){
      powerChart.data.labels=[]; powerChart.data.datasets[0].data=[]; powerChart.data.datasets[1].data=[]; powerChart.update();
      yieldChart.data.labels=[]; yieldChart.data.datasets[0].data=[]; yieldChart.update();
      yieldNote.textContent='(no data)';
      kpiVal.textContent='0.00'; kpiUnit.textContent=' MWh';
      return;
    }

    // POWER (sum across inverters, round)
    const pw=json.power||[];
    powerChart.data.labels = pw.map(x=>{const d=new Date(x.t); return `${pad(d.getHours())}:${pad(d.getMinutes())}`});
    powerChart.data.datasets[0].data = pw.map(x=>Math.round(x.ac||0));
    powerChart.data.datasets[1].data = pw.map(x=>Math.round(x.dc||0));
    powerChart.update();

    // YIELD (bucketed)
    const unit=(json.meta&&json.meta.yieldUnit)||'kWh';
    yieldChart.options.scales.y.title.text=unit;
    let y=json.yield||[],labels=[],values=[];
    if(view==='day'||view==='week'||view==='custom'){ labels=y.map(x=>x.d || x.title || ''); values=y.map(x=>Math.round(x.val ?? x.kwh ?? 0)); }
    if(view==='month'){ labels=y.map(x=>x.ym || ''); values=y.map(x=>Math.round(x.val ?? 0)); }
    if(view==='year'){  labels=y.map(x=>x.y  || ''); values=y.map(x=>Math.round(x.val ?? 0)); }
    if(view==='lifetime'){ labels=['Lifetime']; values=[Math.round(y[0]?.val ?? 0)]; }
    yieldChart.data.labels=labels;
    yieldChart.data.datasets[0].label=`Yield (${unit})`;
    yieldChart.data.datasets[0].data=values;
    yieldChart.update();
    yieldNote.textContent = values.length ? '' : '(no data in range)';

    // KPI auto-scale
    const totalMWh=+((json.cards&&json.cards.TotalYield_MWh)||0);
    let showUnit='MWh',showVal=totalMWh;
    if(totalMWh>=1000){showUnit='GWh';showVal=totalMWh/1000;}
    if(totalMWh<1){showUnit='kWh';showVal=totalMWh*1000;}
    kpiVal.textContent=showVal.toFixed(2);
    kpiUnit.textContent=' '+showUnit;
  }
  const refresh = debounced(_refresh, 180);

  // init
  (async()=>{ await loadPlants(); dateOne.value=ymd(new Date()); refresh(); })();
})();
</script>
</body>
</html>
