<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Solar Plant Dashboard ‚Äì Inverter Analytics</title>
<link rel="stylesheet" href="common/style.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<style>
:root{
  --blue:#0057d8;--orange:#f57c00;--text:#143559;
  --panel:#fff;--shadow:0 2px 8px rgba(0,0,0,.05);
  --bg:#fafbfc;
}
body{margin:0;font-family:"Segoe UI",sans-serif;background:var(--bg);color:var(--text);}
.stage{max-width:1180px;margin:14px auto;background:var(--panel);border-radius:12px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 80px);}
.filters{display:flex;align-items:center;flex-wrap:wrap;gap:8px;font-size:.9rem;border-bottom:1px solid #e7ecf2;padding-bottom:8px;}
label{font-weight:600;font-size:.9rem;}
.multi{position:relative;display:inline-block}
.multi button{border:1px solid var(--blue);border-radius:18px;padding:4px 12px;background:#fff;color:var(--text);font-size:.9rem;min-width:220px;text-align:left;position:relative;}
.multi button::after{content:"‚ñº";position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.7rem;color:var(--text);}
.multi-menu{display:none;position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:8px;width:220px;max-height:240px;overflow-y:auto;z-index:999;}
.multi-menu label{display:block;padding:4px 0;font-size:.85rem;}
.multi-menu input{margin-right:6px;}
.btn{background:#fff;color:var(--blue);border:1px solid var(--blue);border-radius:18px;padding:4px 10px;font-weight:600;height:30px;font-size:.85rem;cursor:pointer;}
.btn.active{background:var(--blue);color:#fff;border:none;}
.grid{display:grid;grid-template-columns:60% 40%;gap:10px;flex:1;}
.card{background:var(--panel);border-radius:10px;box-shadow:var(--shadow);padding:10px;display:flex;flex-direction:column;position:relative;}
.card h2{margin:0 0 4px;font-size:.95rem;font-weight:700;color:var(--text);border-left:4px solid var(--blue);padding-left:6px;}
.nav-arrows{position:absolute;right:8px;top:4px;}
.nav-arrows button{border:none;background:none;color:var(--blue);font-size:16px;cursor:pointer;}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.kpi-card{background:var(--panel);border-radius:10px;box-shadow:var(--shadow);text-align:center;padding:8px;}
.kpi-card.primary{background:linear-gradient(135deg,#0078d7,#00a2ff);color:#fff;}
.kpi-card h4{margin:0;font-size:13px;}
.kpi-card p{margin:2px 0 0;font-size:16px;font-weight:600;}
.fade{animation:fadeIn .4s ease-in-out;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
</style>
</head>

<body>
<div id="header"></div>
<script>
fetch("common/header.html").then(r=>r.text()).then(html=>document.getElementById("header").innerHTML=html);
</script>

<div class="stage">
  <div class="filters">
    <label>üåø Plants:</label>
    <div class="multi">
      <button id="plantBtn">All Plants</button>
      <div id="plantMenu" class="multi-menu"></div>
    </div>
    <label>üîå Inverters:</label>
    <div class="multi">
      <button id="invBtn">All Inverters</button>
      <div id="invMenu" class="multi-menu"></div>
    </div>
    <label>Period:</label>
    <button class="btn period active" data-p="day">Day</button>
    <button class="btn period" data-p="week">Week</button>
    <button class="btn period" data-p="month">Month</button>
    <button class="btn period" data-p="year">Year</button>
    <button class="btn period" data-p="lifetime">Lifetime</button>
    <div class="nav-arrows"><button id="prevBtn">‚Üê</button><button id="nextBtn">‚Üí</button></div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card primary"><h4>Total Yield</h4><p id="totalYield">--</p></div>
    <div class="kpi-card"><h4>CUF</h4><p>--</p></div>
    <div class="kpi-card"><h4>PR</h4><p>--</p></div>
  </div>

  <div class="grid">
    <div class="card fade"><h2>Power Curve</h2><canvas id="curve"></canvas></div>
    <div class="card fade"><h2>Yield Trend</h2><canvas id="yield"></canvas></div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);
let plants=[],inverters=[],period='day',nav=0,cache=null,pcChart=null,ytChart=null;

document.addEventListener("DOMContentLoaded",init);

async function init(){
  await loadFilters();
  attachEvents();
  fetchData();
}

async function loadFilters(){
  const r=await fetch('/api/PlantDirectory');const raw=await r.json();
  plants=(raw||[]).sort((a,b)=>a.Plant_Name.localeCompare(b.Plant_Name));
  inverters=[...new Set(plants.flatMap(p=>(p.Inverters||"").split(',').map(x=>x.trim()).filter(Boolean)))].sort();

  const pMenu=document.getElementById('plantMenu');
  const iMenu=document.getElementById('invMenu');
  pMenu.innerHTML=`<label><input type="checkbox" value="all" checked> All Plants</label>`;
  iMenu.innerHTML=`<label><input type="checkbox" value="all" checked> All Inverters</label>`;
  plants.forEach(p=>pMenu.innerHTML+=`<label><input type="checkbox" value="${p.Plant_ID}"> ${p.Plant_Name}</label>`);
  inverters.forEach(i=>iMenu.innerHTML+=`<label><input type="checkbox" value="${i}"> ${i}</label>`);

  const toggle=(menu,btn)=>{btn.onclick=()=>menu.style.display=menu.style.display==='block'?'none':'block';
    window.addEventListener('click',e=>{if(!e.target.closest('.multi'))menu.style.display='none';});};
  toggle(pMenu,document.getElementById('plantBtn'));
  toggle(iMenu,document.getElementById('invBtn'));
}

function attachEvents(){
  document.querySelectorAll('.period').forEach(b=>b.onclick=()=>{document.querySelectorAll('.period').forEach(x=>x.classList.remove('active'));b.classList.add('active');period=b.dataset.p;fetchData();});
  document.getElementById('prevBtn').onclick=()=>{nav--;fetchData();};
  document.getElementById('nextBtn').onclick=()=>{nav++;fetchData();};
}

function selectedVals(menuId,allList){
  const cbs=[...document.querySelectorAll(`#${menuId} input[type=checkbox]`)];
  if(cbs.find(x=>x.value==='all'&&x.checked)) return allList;
  return cbs.filter(x=>x.checked&&x.value!=='all').map(x=>x.value);
}

async function fetchData(){
  const plantSel=selectedVals('plantMenu',plants.map(p=>p.Plant_ID));
  const invSel=selectedVals('invMenu',inverters);
  const url=`/api/GetInverterData?period=${period}&nav=${nav}&plants=${plantSel.join(',')}&inverters=${invSel.join(',')}`;
  const r=await fetch(url); cache=await r.json();
  render();
}

function autoUnit(v){return v>=1e6?'GWh':v>=1e3?'MWh':'kWh';}
function scale(v,u){return u==='GWh'?v/1e6:u==='MWh'?v/1e3:v;}

function render(){
  if(!cache) return;
  const tVal=Number(cache.totalYield||0),u=cache.yieldUnit||'kWh';
  document.getElementById('totalYield').textContent=`${tVal.toFixed(2)} ${u}`;
  drawCurve(cache.powerCurve||[]);
  drawYield(cache.yieldTrend||[]);
}

function drawCurve(arr){
  const ctx=document.getElementById('curve').getContext('2d');
  if(pcChart) pcChart.destroy();
  if(!arr.length) return;
  pcChart=new Chart(ctx,{
    type:'line',
    data:{labels:arr.map(x=>x.time),
      datasets:[
        {label:'DC Power (kW)',data:arr.map(x=>x.dc),borderColor:'#f57c00',tension:.2,fill:{target:'origin',above:'rgba(245,124,0,0.1)'}},
        {label:'AC Power (kW)',data:arr.map(x=>x.ac),borderColor:'#0078d7',tension:.2,fill:{target:'origin',above:'rgba(0,120,215,0.1)'}}
      ]},
    options:{plugins:{legend:{display:true,position:'bottom'},
      datalabels:{color:(ctx)=>ctx.dataset.label.includes('DC')?'#d35400':'#003366',anchor:'end',align:(ctx)=>ctx.dataset.label.includes('DC')?'end':'start',
        font:{size:9},formatter:(v)=>v?Number(v).toFixed(1):''}},
      scales:{y:{beginAtZero:true},x:{ticks:{callback:(v,i,vals)=>i%4===0?arr[i]?.time.split('T')[1].slice(0,5):''}}}},
    plugins:[ChartDataLabels]
  });
}

function drawYield(arr){
  const ctx=document.getElementById('yield').getContext('2d');
  if(ytChart) ytChart.destroy();
  if(!arr.length) return;
  const vals=arr.map(x=>x.valueKWh||0);
  const u=autoUnit(Math.max(...vals,1));
  const scaled=vals.map(v=>scale(v,u));
  ytChart=new Chart(ctx,{
    type:'bar',
    data:{labels:arr.map(x=>x.label),
      datasets:[{data:scaled,backgroundColor:'#0078d7',borderRadius:4}]},
    options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',color:'#003366',font:{size:9},formatter:v=>v.toFixed(1)}},
      scales:{y:{beginAtZero:true}}},
    plugins:[ChartDataLabels]
  });
}
</script>
</body>
</html>
