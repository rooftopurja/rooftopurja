<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Inverter Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi{flex:1 1 220px}
    .kpi .label{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.06em}
    .kpi .value{font-size:28px;font-weight:700;margin-top:4px}
    .controls{gap:8px;align-items:center}
    select,input,button{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .seg button{padding:8px 12px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .seg button.active{background:#111;color:#fff;border-color:#111}
    .chart-card{flex:1 1 520px;min-width:320px}
    .muted{color:#6b7280;font-size:12px}
    .spinner{display:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<link rel="stylesheet" href="/nav.css"><div id="global-nav"></div><script src="/nav.js" defer></script>
<header>
  <div class="wrap row controls">
    <div style="font-weight:700;">Inverter Analytics</div>
    <div style="flex:1"></div>
    <label>Plant</label>
    <select id="plantSel">
      <option value="all">All Plants</option>
      <!-- you can append more options later via PlantDirectory -->
    </select>
    <label>Date</label>
    <input type="date" id="dayPicker" />
    <div class="seg" id="viewSeg">
      <button data-view="day"   class="active">Day</button>
      <button data-view="week">Week</button>
      <button data-view="month">Month</button>
      <button data-view="year">Year</button>
    </div>
    <button id="refreshBtn">Refresh</button>
    <div id="spin" class="muted spinner">Loading…</div>
  </div>
</header>

<main class="wrap">
  <div class="row">
    <div class="card kpi">
      <div class="label">Total Yield</div>
      <div class="value"><span id="kpiYieldValue">0</span> <span id="kpiYieldUnit">kWh</span></div>
      <div class="muted" id="kpiDate"></div>
    </div>
    <div class="card kpi">
      <div class="label">CUF</div>
      <div class="value">—</div>
      <div class="muted">Coming soon</div>
    </div>
    <div class="card kpi">
      <div class="label">PR</div>
      <div class="value">—</div>
      <div class="muted">Coming soon</div>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <div class="card chart-card">
      <div class="muted" style="margin-bottom:6px;">Power (AC/DC) vs Time</div>
      <canvas id="powerChart" height="220"></canvas>
    </div>
    <div class="card chart-card">
      <div class="muted" style="margin-bottom:6px;">Yield</div>
      <canvas id="yieldChart" height="220"></canvas>
    </div>
  </div>
</main>

<script>
const spin = document.getElementById('spin');
const dayPicker = document.getElementById('dayPicker');
const plantSel = document.getElementById('plantSel');
const viewSeg = document.getElementById('viewSeg');
const refreshBtn = document.getElementById('refreshBtn');

function todayYMDIST(){
  // Build IST "today" Y-M-D from client time (simple)
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
dayPicker.value = todayYMDIST();

let currentView = 'day';
viewSeg.addEventListener('click', (e)=>{
  if(e.target.tagName==='BUTTON'){
    [...viewSeg.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    currentView = e.target.dataset.view;
  }
});

let powerChart, yieldChart;
function ensureCharts(){
  if(!powerChart){
    const ctx = document.getElementById('powerChart').getContext('2d');
    powerChart = new Chart(ctx,{
      type:'line',
      data:{ labels:[], datasets:[
        { label:'AC Power (kW)', data:[], fill:false, tension:0.2 },
        { label:'DC Power (kW)', data:[], fill:false, tension:0.2 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true } }, y:{} },
        plugins:{ legend:{ position:'bottom' } }
      }
    });
  }
  if(!yieldChart){
    const ctx = document.getElementById('yieldChart').getContext('2d');
    yieldChart = new Chart(ctx,{
      type:'bar',
      data:{ labels:[], datasets:[ { label:'Yield', data:[] } ]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ }, y:{ beginAtZero:true } }
      }
    });
  }
}

async function fetchAnalytics(){
  const plantId = plantSel.value || 'all';
  const date = dayPicker.value; // Y-M-D
  const url = new URL(location.origin + '/api/inverter/analytics');
  url.searchParams.set('view', currentView);
  url.searchParams.set('plantId', plantId);
  if (currentView === 'day' || currentView === 'week' || currentView === 'month' || currentView === 'year') {
    // day param accepted for all; backend uses IST
    if (date) url.searchParams.set('date', date);
  }
  spin.style.display = 'inline';
  const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
  spin.style.display = 'none';
  if(!res.ok){
    alert('API error: '+res.status);
    return null;
  }
  return await res.json();
}

function updateUI(payload){
  // KPIs
  const k = payload?.kpis || {};
  document.getElementById('kpiYieldValue').textContent = (k.total_yield ?? 0);
  document.getElementById('kpiYieldUnit').textContent  = (k.unit || 'kWh');
  document.getElementById('kpiDate').textContent = `View: ${payload?.parameters?.view} • Date: ${payload?.parameters?.date}`;

  ensureCharts();

  // Power chart (only for day view)
  if (payload?.power && Array.isArray(payload.power)) {
    const labels = payload.power.map(p => new Date(p.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
    const ac = payload.power.map(p => p.ac ?? 0);
    const dc = payload.power.map(p => p.dc ?? 0);
    powerChart.data.labels = labels;
    powerChart.data.datasets[0].data = ac;
    powerChart.data.datasets[1].data = dc;
    powerChart.update();
  } else {
    powerChart.data.labels = [];
    powerChart.data.datasets[0].data = [];
    powerChart.data.datasets[1].data = [];
    powerChart.update();
  }

  // Yield chart (bars)
  if (payload?.yield && Array.isArray(payload.yield)) {
    yieldChart.data.labels = payload.yield.map(y => y.label);
    yieldChart.data.datasets[0].data = payload.yield.map(y => y.value ?? 0);
    yieldChart.update();
  } else {
    yieldChart.data.labels = [];
    yieldChart.data.datasets[0].data = [];
    yieldChart.update();
  }
}

async function run(){ const data = await fetchAnalytics(); if(data) updateUI(data); }
refreshBtn.addEventListener('click', run);

// Initial load
run();
</script>
</body>
</html>





